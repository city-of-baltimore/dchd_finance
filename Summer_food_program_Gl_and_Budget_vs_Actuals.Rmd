---
title: "Summer Food Program Plots"
author: "Selenea Gibson and Jason Howard"
date: "2025-01-23"
output: html_document
---

# Project Overview
This markdown file will use the DHCD Finance dept data to calculate the columns that are provided from the `754 SFSP Expense Report`. There will be a series of plots to make the tables at the bottom of the report more appealing for what is being shown. This will be done through visuals.

```{r libraries, warning=FALSE, message=TRUE}
# libraries for data analysis
library(dplyr)
library(here)
library(tidyverse)
library(scales)
library(DT)
library(openxlsx)
library(stringr)
library(lubridate)
library(hrbrthemes)
library(ggplot2)
```


## Reading in the data 
Reading in the files for the data that will be used for creating the plots that will represent the data on the bottom of the `754 SFSP Expense Report`.

```{r readingdata}
# reading in the dataset for the summer_expense_report
bud_vs_actuals <- read.xlsx(here("FY 2024 Budget and Actual as of 12_31_2024.xlsx"))

# set the first row as headers and remove it from the data
bud_vs_actuals <- setNames(bud_vs_actuals[-1, ], as.character(unlist(bud_vs_actuals[1, ])))
```

<<<<<<< HEAD

## Cleaning the datasets
I need to remove some of the rows that are not needed for the analysis. I will then make the new row be the header row. 

```{r cleaningdata}
# add round all expenditure days to the expenditure month
gl_data <- gl_data |> 
  mutate(expend_month = floor_date(`Accounting Date` , unit = "month"))

# remove columns that have nulls for all values 
# replace "blank" with an actual 'null' value
budg_vs_actuals <- budg_vs_actuals |> 
  select_if(~sum(!is.na(.)) > 0) |> 
  mutate(Grant = ifelse(Grant == "(Blank)", NA_character_, Grant))

```
=======
>>>>>>> 8489e411ef92aaf03edb99dd2480afbf8b440db0


####
## Creating calculations for the tables
Creating the calculations for the tables. There will be a total of 10 tables that are from the `754 SFSP Expense Report`. 

*First calculations include the Revised Budget*
*Second calculations include the GL_YTD_EXP*
*Third calculations include the Analysis Table*
*Fourth calculation include the Percentage Table*
####



### General Funds 1001 Table
*First calculations include the Revised Budget*


```{r slicingfirst, warning=FALSE}
# --- slicing the rows for the analysis ---

# slice the rows that I want for the analysis that uses the 1001 General Funds values only 
gf_first_rows  <-  bud_vs_actuals |> 
  slice(1:2) 

gf_remaining_rows <- bud_vs_actuals |> 
  slice(3:11)

# --- grouping by the spend cat and making a new column ---

gf_first_sum <- gf_first_rows |> 
  group_by(`Spend Category`) |> 
  summarise(`salaries/opc projections` = sum(as.numeric(`Revised Budget`), na.rm = TRUE)) |> 
  ungroup()

gf_remaining_sum <- gf_remaining_rows |> 
  group_by(`Spend Category`) |> 
  summarise(`Other EXP projection` = sum(as.numeric(`Revised Budget`), na.rm = TRUE)) |> 
  ungroup()

# --- bind the rows together ---

gf_summary <- bind_rows(gf_first_sum, gf_remaining_sum) 

# --- create the final table --- 

# this will be use to plot the data at the end in the plotting section.

gf_final_tbl <- gf_summary |> 
  summarise(
    `Salaries/OPC Projections` = sum(`salaries/opc projections`, na.rm = TRUE),
    `Other EXP Projections` = sum(`Other EXP projection`, na.rm = TRUE),
    `Total Projections` = `Salaries/OPC Projections` + `Other EXP Projections`
  )
```


### Other Funds - 2089, 4000, and 5000 table

```{r slicingsecond, warning=FALSE}
# --- slicing the rows for the analysis ---

# slice the rows that use the 5000 State Grant values only 
sg_first_rows  <- bud_vs_actuals |> 
  slice(12:25) 

sg_remaining_rows <- bud_vs_actuals |> 
  slice(26:51)

# --- grouping by Spend Category and summarizing ---

sg_first_sum <- sg_first_rows |> 
  group_by(`Spend Category`) |> 
  summarise(`salaries/opc projections` = sum(as.numeric(`Revised Budget`), na.rm = TRUE)) |> 
  ungroup()

sg_remaining_sum <- sg_remaining_rows |> 
  group_by(`Spend Category`) |> 
  summarise(`Other EXP projection` = sum(as.numeric(`Revised Budget`), na.rm = TRUE)) |> 
  ungroup()

# --- bind the rows together ---

sg_summary <- bind_rows(sg_first_sum, sg_remaining_sum) 

# --- create the final summary table for plotting ---

sg_final_tbl <- sg_summary |> 
  summarise(
    `Salaries/OPC Projections` = sum(`salaries/opc projections`, na.rm = TRUE),
    `Other EXP Projections` = sum(`Other EXP projection`, na.rm = TRUE),
    `Total Projections` = `Salaries/OPC Projections` + `Other EXP Projections`
  )

```

<<<<<<< HEAD

###
## Calculations for workbook tables
Calculating the gl_ytd_exp column. I will also rename the `Total Actual` column to the `Total Expenditure` column. Then join the gl table to the expense report table. Then calculate the columns that are needed for the analysis table. 
=======
>>>>>>> 8489e411ef92aaf03edb99dd2480afbf8b440db0

### Total Projections equals to row 268 

```{r tpetblone, warning=FALSE}
# --- bind the rows together ---

tpe_summary <- bind_rows(gf_final_tbl, sg_final_tbl)

# --- create the tpe_rb_final_tbl table ---

tpe_rb_final_tbl <- tpe_summary |> 
  summarise(
    `Salaries/OPC Projections` = sum(as.numeric(`Salaries/OPC Projections`), na.rm = TRUE),
    `Other EXP Projections` = sum(as.numeric(`Other EXP Projections`), na.rm = TRUE),
    `Total Projections` = `Salaries/OPC Projections` + `Other EXP Projections`
  )
```

<<<<<<< HEAD

1. Create the summary table that houses the summer food expense data.
=======
>>>>>>> 8489e411ef92aaf03edb99dd2480afbf8b440db0

### GL_YTD_EXP Tables
*Second calculations include the GL_YTD_EXP*

### GL_YTD_EXP General Funds 1001 Table
This is for the GL_YTD_EXP Tables.

```{r gfgly, warning=FALSE}
# --- grouping by Spend Category and summarizing ---

<<<<<<< HEAD

2. Calculating the columns for the Analysis Table
Create the columns that are needed for the second table that is in the `754 SFSP Expense Report`.
=======
glytd_gf_first_sum <- gf_first_rows |> 
  group_by(`Spend Category`) |> 
  summarise(`salaries/opc projections` = sum(as.numeric(`GL YTD EXP`), na.rm = TRUE)) |> 
  ungroup()
>>>>>>> 8489e411ef92aaf03edb99dd2480afbf8b440db0

glytd_gf_remaining_sum <- gf_remaining_rows |> 
  group_by(`Spend Category`) |> 
  summarise(`Other EXP projection` = sum(as.numeric(`GL YTD EXP`), na.rm = TRUE)) |> 
  ungroup()

# --- bind the rows together ---

glytd_gf_summary <- bind_rows(glytd_gf_first_sum, glytd_gf_remaining_sum) 

# --- create the final summary table for plotting ---

glytd_gf_final_tbl <- glytd_gf_summary |> 
  summarise(
    `Salaries/OPC Projections` = sum(`salaries/opc projections`, na.rm = TRUE),
    `Other EXP Projections` = sum(`Other EXP projection`, na.rm = TRUE),
    `Total Projections` = `Salaries/OPC Projections` + `Other EXP Projections`
  )

```


### Other Funds - 2089, 4000, and 5000 table
This is for the GL_YTD_EXP Tables.

```{r ofgl, warning=FALSE}
# --- grouping by the spend cat and making a new column ---

glytd_sg_first_sum <- sg_first_rows |> 
  group_by(`Spend Category`) |> 
  mutate(
    `salaries/opc projections` = sum(as.numeric(`GL YTD EXP`), na.rm = TRUE)
  ) |> 
  ungroup() 
  
glytd_sg_remaining_sum <- sg_remaining_rows |> 
  group_by(`Spend Category`) |> 
  mutate(
    `Other EXP projection` = sum(as.numeric(`GL YTD EXP`), na.rm = TRUE)
  ) |> 
  ungroup() 

# --- bind the rows together ---

glytd_sg_summary <- bind_rows(glytd_sg_first_sum, glytd_sg_remaining_sum) 

# --- create the final table --- 

# this will be use to plot the data at the end in the plotting section.

glytd_sg_final_tbl <- glytd_sg_summary |> 
  summarise(
    `Salaries/OPC Projections` = sum(`salaries/opc projections`, na.rm = TRUE),
    `Other EXP Projections` = sum(`Other EXP projection`, na.rm = TRUE),
    `Total Projections` = `Salaries/OPC Projections` + `Other EXP Projections`
  )
```


### Total Projections equals to row 268 
This is for the GL_YTD_EXP Tables.

```{r tpetwo, warning=FALSE}
# --- bind the rows together ---

glytd_tpe_summary <- bind_rows(glytd_gf_final_tbl, glytd_sg_final_tbl) 

# --- create the final TPE summary table for plotting ---

glytd_tpe_final_tbl <- glytd_tpe_summary |> 
  summarise(
    `Salaries/OPC Projections` = sum(`Salaries/OPC Projections`, na.rm = TRUE),
    `Other EXP Projections` = sum(`Other EXP Projections`, na.rm = TRUE),
    `Total Projections` = `Salaries/OPC Projections` + `Other EXP Projections`
  )
```


*Third calculations include the Analysis Table*

### General Funds 1001 Table
This is for the Analysis Tables.

```{r antblone, warning=FALSE}

# --- grouping by Spend Category and summarizing ---

alysgf_first_sum <- gf_first_rows |> 
  group_by(`Spend Category`) |> 
  summarise(
    `Remaining Balance - Salaries/OPC` = sum(as.numeric(`Remaining Balance`), na.rm = TRUE),
    `Projected YE Value - Salaries/OPC` = sum(as.numeric(`Projected Y|E Value`), na.rm = TRUE),
    `Sur/(Def) - Salaries/OPC` = sum(as.numeric(`Sur / (Def)`), na.rm = TRUE)
  ) |> 
  ungroup()

alysgf_remaining_sum <- gf_remaining_rows |> 
  group_by(`Spend Category`) |> 
  summarise(
    `Remaining Balance - Other EXP` = sum(as.numeric(`Remaining Balance`), na.rm = TRUE),
    `Projected YE Value - Other EXP` = sum(as.numeric(`Projected Y|E Value`), na.rm = TRUE),
    `Sur/(Def) - Other EXP` = sum(as.numeric(`Sur / (Def)`), na.rm = TRUE)
  ) |> 
  ungroup()

# --- bind the rows together ---

alysgf_summary <- bind_rows(alysgf_first_sum, alysgf_remaining_sum) 

# --- create the final table for plotting ---

alysgf_final_tbl <- alysgf_summary |> 
  summarise(
    `Salaries/OPC Projections` = sum(`Remaining Balance - Salaries/OPC`, na.rm = TRUE) +
                                 sum(`Projected YE Value - Salaries/OPC`, na.rm = TRUE) +
                                 sum(`Sur/(Def) - Salaries/OPC`, na.rm = TRUE),
    
    `Other EXP Projections` = sum(`Remaining Balance - Other EXP`, na.rm = TRUE) +
                              sum(`Projected YE Value - Other EXP`, na.rm = TRUE) +
                              sum(`Sur/(Def) - Other EXP`, na.rm = TRUE),
    
    `Total Projections` = `Salaries/OPC Projections` + `Other EXP Projections`
  )
```


### Other Funds - 2089, 4000, and 5000 table
This is for the Analysis Tables.

```{r tblothfunan, warning=FALSE}
# --- grouping by Spend Category and summarizing ---

alysg_first_sum <- sg_first_rows |> 
  group_by(`Spend Category`) |> 
  summarise(
    `Remaining Balance - Salaries/OPC` = sum(as.numeric(`Remaining Balance`), na.rm = TRUE),
    `Projected YE Value - Salaries/OPC` = sum(as.numeric(`Projected Y|E Value`), na.rm = TRUE),
    `Sur/(Def) - Salaries/OPC` = sum(as.numeric(`Sur / (Def)`), na.rm = TRUE)
  ) |> 
  ungroup()

alysg_remaining_sum <- sg_remaining_rows |>  # Fixed incorrect reference
  group_by(`Spend Category`) |> 
  summarise(
    `Remaining Balance - Other EXP` = sum(as.numeric(`Remaining Balance`), na.rm = TRUE),
    `Projected YE Value - Other EXP` = sum(as.numeric(`Projected Y|E Value`), na.rm = TRUE),
    `Sur/(Def) - Other EXP` = sum(as.numeric(`Sur / (Def)`), na.rm = TRUE)
  ) |> 
  ungroup()  

# --- bind the rows together ---

alysg_summary <- bind_rows(alysg_first_sum, alysg_remaining_sum) 

# --- create the final table for plotting ---

alysg_final_tbl <- alysg_summary |> 
  summarise(
    `Salaries/OPC Projections` = sum(`Remaining Balance - Salaries/OPC`, na.rm = TRUE) +
                                 sum(`Projected YE Value - Salaries/OPC`, na.rm = TRUE) +
                                 sum(`Sur/(Def) - Salaries/OPC`, na.rm = TRUE),
    
    `Other EXP Projections` = sum(`Remaining Balance - Other EXP`, na.rm = TRUE) +
                              sum(`Projected YE Value - Other EXP`, na.rm = TRUE) +
                              sum(`Sur/(Def) - Other EXP`, na.rm = TRUE),
    
    `Total Projections` = `Salaries/OPC Projections` + `Other EXP Projections`
  )
```


### Total Projections equals to row 268 
This is for the Analysis Tables.

```{r antpe, warning=FALSE}
# --- bind the rows together ---

alys_tpe_summary <- bind_rows(alysgf_final_tbl, alysg_final_tbl) 

# --- create the final TPE table ---

alys_tpe_final_tbl <- alys_tpe_summary |> 
  summarise(
    `Salaries/OPC Projections` = sum(as.numeric(`Salaries/OPC Projections`), na.rm = TRUE),
    `Other EXP Projections` = sum(as.numeric(`Other EXP Projections`), na.rm = TRUE),
    `Total Projections` = `Salaries/OPC Projections` + `Other EXP Projections`
  )
```


*Fourth calculation include the Percentage Table*

### Percentage Calculations
Here is a table that will calculate the percentages for the Percentage of Budget Depleted YTD Table.
Using the `pull` function which ensures a single numeric value is extracted rather than a dataframe column.

```{r percentages, warning=FALSE}
pcnt_final_tbl <- tibble(
  `Total Salaries` = round((pull(glytd_tpe_final_tbl, `Salaries/OPC Projections`)) / 
                           (pull(tpe_rb_final_tbl, `Salaries/OPC Projections`)) * 100, 0), # ensures that the output is rounded to the next whole num
  `Total Expenses` = round((pull(glytd_tpe_final_tbl, `Other EXP Projections`)) / 
                           (pull(tpe_rb_final_tbl, `Other EXP Projections`)) * 100, 0),
  `Overall Total`  = round((pull(glytd_tpe_final_tbl, `Total Projections`)) / 
                           (pull(tpe_rb_final_tbl, `Total Projections`)) * 100, 0)
)
```



#####
### Plotting the data for visulzations


The tables that have the name `final` in them will be used for the plots. These plots will serve as a way to make the data represent what the tables are showing within the main dataset. 

*First table compares the General Fund 1001 and the GL YTD EXP General Fund*
*Second table compares the Other Funds - 2089, 4000,  and 5000 and the GL YTD EXP State Grants*
*Third table compares the Total Projections Equals to Row 268 and GL YTD EXP General Fund 1001*
*Fourth table shows the Percent of Budget Depleted YTD Table Data*
*Fifth table compares the Remaining Balance, Sur/ Def, and Projected Y|E Value for the Analysis table General Fund 1001*
*Sixth table compares the Remaining Balance, Sur/ Def, and Projected Y|E Value for the Analysis table Other Funds - 2089, 4000,  and 5000 table*
*Seventh table compares the Remaining Balance, Sur/ Def, and Projected Y|E Value for the Analysis Total Projections equals to row 268 table*
#####



### General Funds 1001 and Generl Funds 1001 GL YTD EXP comparison plot
The plot below will compare the GF and the GLYTD EXP General Funds 1001 data together. The `gf_glytd_comparison_data` includes the spending categories that are within the General Funds 1001. This will show which if the budget is close or over for the total overall budget of the spending categories. 


```{r gfirstplot, warning=FALSE}
gf_glytd_comparison_data <- data.frame(
  Category = rep(c("Salaries/OPC Projections", "Other EXP Projections"), each = nrow(gf_final_tbl) * 2),
  Fund = rep(c("1001 General Funds", "GL YTD 1001 General Funds"), each = nrow(gf_final_tbl), times = 2),
  Value = c(gf_final_tbl$`Salaries/OPC Projections`, glytd_gf_final_tbl$`Salaries/OPC Projections`,
            gf_final_tbl$`Other EXP Projections`, glytd_gf_final_tbl$`Other EXP Projections`)
)

# Step 2: Calculate the total revised budget for the first rows defined in the dataset
# Sum the Revised Budget from both gf_first_rows and gf_remaining_rows
total_projections_gf <- sum(as.numeric(gf_first_rows$`Revised Budget`), na.rm = TRUE) + 
                        sum(as.numeric(gf_remaining_rows$`Revised Budget`), na.rm = TRUE)


# Step 3: Create the stacked horizontal bar chart with two threshold lines
ggplot(gf_glytd_comparison_data, aes(x = Category, y = Value, fill = Fund)) +
  geom_bar(stat = "identity", position = "stack") +  # Stacked bars
  geom_segment(aes(x = 1, xend = 2.5, y = total_projections_gf, yend = total_projections_gf), 
               linetype = "dashed", color = "blue", size = 1) +  # Short horizontal line for General Fund
  annotate("text", x = 2.5, y = total_projections_gf, 
           label = paste("Revised Budget", label_dollar()(total_projections_gf)), 
           color = "blue", vjust = -0.5, size = 6) +  # Label for General Fund line with formatted dollar value
  coord_flip() +  # Flip to make bars horizontal
  labs(title = "1001 General Funds and General Ledger YTD Comaparisons",
       subtitle = "1001 General Funds",
       x = "Category", y = "Amount") +
  scale_y_continuous(labels = label_dollar()) +  # Format y-axis labels as dollar values
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 14),  # Increase legend text size
        plot.title = element_text(hjust = 0.5, size = 16),  # Increase plot title size
        plot.subtitle = element_text(hjust = 0, size = 14),
        axis.title.x = element_text(size = 14, face = "bold"),  # Increase x-axis title size
        axis.title.y = element_text(size = 14, face = "bold"),  # Increase y-axis title size
        axis.text.x = element_text(size = 14),  # Increase x-axis labels size
        axis.text.y = element_text(size = 14))  # Increase y-axis labels size


# save the plot
ggsave("Charts/gf_glytd_comparison_data.png",width = 18, height = 16, dpi = 300)  
```


### 5000 State Grants Fund Other Funds - 2089, 4000, and 5000 and GL YTD EXP comparison plot
The plot below will compare the State Grants Fund and the GLYTD EXP 5000 State Grants data together. The `sg_glty_Revised Budget` includes the spending categories that are within the 5000 State Grants Fund. This will show which if the budget is close or over for the total overall budget of the spending categories. 


```{r sf_sfglyt_plot, warning=FALSE}
sg_glytd_comparison_data <- data.frame(
  Category = rep(c("Salaries/OPC Projections", "Other EXP Projections"), each = nrow(sg_final_tbl) * 2),
  Fund = rep(c("5000 State Grants Funds", "GL YTD 5000 State Grants Funds"), each = nrow(sg_final_tbl), times = 2),
  Value = c(sg_final_tbl$`Salaries/OPC Projections`, glytd_sg_final_tbl$`Salaries/OPC Projections`,
            sg_final_tbl$`Other EXP Projections`, glytd_sg_final_tbl$`Other EXP Projections`)
)

# Step 2: Calculate the total revised budget for the first rows defined in the dataset
# Sum the Revised Budget from both gf_first_rows and gf_remaining_rows
total_projections_sg <- sum(as.numeric(sg_first_rows$`Revised Budget`), na.rm = TRUE) + 
                        sum(as.numeric(sg_remaining_rows$`Revised Budget`), na.rm = TRUE)


# Step 3: Create the stacked horizontal bar chart with two threshold lines
ggplot(sg_glytd_comparison_data, aes(x = Category, y = Value, fill = Fund)) +
  geom_bar(stat = "identity", position = "stack") +  # Stacked bars
  geom_segment(aes(x = 1, xend = 2.5, y = total_projections_sg, yend = total_projections_sg), 
               linetype = "dashed", color = "blue", size = 1) +  # Short horizontal line for General Fund
  annotate("text", x = 2.5, y = total_projections_sg, 
           label = paste("Revised Budget", label_dollar()(total_projections_sg)), 
           color = "blue", vjust = -0.5, size = 6) +  # Label for General Fund line with formatted dollar value
  coord_flip() +  # Flip to make bars horizontal
  labs(title = "Other Funds - 2089, 4000, and 5000 and General Ledger YTD Comparisons",
       subtitle = "5000 State Grant Funds",
       x = "Category", y = "Amount") +
  scale_y_continuous(labels = label_dollar()) +  # Format y-axis labels as dollar values
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 14),  # Increase legend text size
        plot.title = element_text(hjust = 0.5, size = 16),  # Increase plot title size
        plot.subtitle = element_text(hjust = 0, size = 14),
        axis.title.x = element_text(size = 14, face = "bold"),  # Increase x-axis title size
        axis.title.y = element_text(size = 14, face = "bold"),  # Increase y-axis title size
        axis.text.x = element_text(size = 14),  # Increase x-axis labels size
        axis.text.y = element_text(size = 14))  # Increase y-axis labels size


# save the plot
ggsave("Charts/sg_glytd_comparison_data.png",width = 18, height = 16, dpi = 300)  
```


### Total Projections Equals to Row 268 and GL YTD EXP - 1001 General Funds and 5000 State Grants comparison plot
The plot below will compare the General Grants Fund and the GLYTD EXP 5000 State Grants data together. The `tpe_glytd_comparison_data` includes the spending categories that are within the 1001 General Grants and 5000 State Grants Fund. This will show which if the budget is close or over for the total overall budget of the spending categories. 


```{r tpe_plot, warning=FALSE}
# calculate the columns that would be needed for plotting
tpe_glytd_comparison_data <- data.frame(
  Category = rep(c("Salaries/OPC Projections", "Other EXP Projections"), 
                 each = nrow(gf_final_tbl) + nrow(sg_final_tbl)),  # Adjusting replication
  
  Fund = c(rep("1001 General Grants Fund", nrow(gf_final_tbl)), 
           rep("GL YTD EXP 1001 General Grants Fund", nrow(gf_final_tbl)), 
           rep("5000 State Grants Fund", nrow(sg_final_tbl)), 
           rep("GL YTD EXP 5000 State Grants Fund", nrow(sg_final_tbl))),  # Assigning funds correctly
  
  Value = c(tpe_rb_final_tbl$`Salaries/OPC Projections`, 
            glytd_tpe_final_tbl$`Salaries/OPC Projections`, 
            tpe_rb_final_tbl$`Other EXP Projections`, 
            glytd_tpe_final_tbl$`Other EXP Projections`)  # Matching values correctly
)


# Step 2: Calculate the total revised budget for the first rows defined in the dataset
# Sum the Revised Budget from both gf_first_rows and gf_remaining_rows
total_projections_tpeglytd <- sum(as.numeric(gsub("[^0-9.]", "", sg_first_rows$`Revised Budget`)), na.rm = TRUE) + 
                        sum(as.numeric(gsub("[^0-9.]", "", sg_remaining_rows$`Revised Budget`)), na.rm = TRUE) +
  sum(as.numeric(gsub("[^0-9.]", "", gf_first_rows$`Revised Budget`)), na.rm = TRUE) + 
                        sum(as.numeric(gsub("[^0-9.]", "", gf_remaining_rows$`Revised Budget`)), na.rm = TRUE)


# Step 3: Create the stacked horizontal bar chart with two threshold lines
ggplot(tpe_glytd_comparison_data, aes(x = Category, y = Value, fill = Fund)) +
  geom_bar(stat = "identity", position = "stack") +  # Stacked bars
  geom_segment(aes(x = 1, xend = 2.5, y = total_projections_tpeglytd, yend = total_projections_tpeglytd), 
               linetype = "dashed", color = "blue", size = 1) +  # Short horizontal line for General Fund
  annotate("text", x = 2.5, y = total_projections_tpeglytd, 
           label = paste("Revised Budget", label_dollar()(total_projections_tpeglytd)), 
           color = "blue", vjust = -0.5, size = 6) +  # Label for General Fund line with formatted dollar value
  coord_flip() +  # Flip to make bars horizontal
  labs(title = "Total Projections Equals to Row 268 and GL YTD EXP Comaparisons",
       subtitle = "1001 General Funds and 5000 State Grant Funds",
       x = "Category", y = "Amount") +
  scale_y_continuous(labels = label_dollar()) +  # Format y-axis labels as dollar values
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 14),  # Increase legend text size
        plot.title = element_text(hjust = 0.5, size = 16),  # Increase plot title size
        plot.subtitle = element_text(hjust = 0, size = 14),
        axis.title.x = element_text(size = 14, face = "bold"),  # Increase x-axis title size
        axis.title.y = element_text(size = 14, face = "bold"),  # Increase y-axis title size
        axis.text.x = element_text(size = 14),  # Increase x-axis labels size
        axis.text.y = element_text(size = 14))  # Increase y-axis labels size


# save the plot
ggsave("Charts/tpe_glytd_comparison_data.png",width = 18, height = 16, dpi = 300)  
```


### Percent of Budget Depleted YTD Table Data plot
The plot below will compare the glytd and tp data in the Percentage of Budget Depleted YTD comparison. The `pcnt_final_data` includes the spending categories that are within the 1001 General Grants Fund. This will show which if the budget is close or over for the total overall budget of the spending categories. 


```{r pct_plot, warning=FALSE}
# create a percentage comparison dataframe
pcnt_final_data <- data.frame(
  Category = rep(c("Total Salaries", "Total Expenses", "Overall Total"), each = nrow(pcnt_final_tbl)),  
  Fund = rep("GL YTD EXP 1001 General & 5000 State Grants Funds", nrow(pcnt_final_tbl) * 3),  # Repeat the fund name for each category
  Value = round(c(
    (glytd_tpe_final_tbl$`Salaries/OPC Projections` / tpe_rb_final_tbl$`Salaries/OPC Projections`) * 100,  
    (glytd_tpe_final_tbl$`Other EXP Projections` / tpe_rb_final_tbl$`Other EXP Projections`) * 100,
    (glytd_tpe_final_tbl$`Total Projections` / tpe_rb_final_tbl$`Total Projections`) * 100
  ), 0)  # Round to whole numbers
)


# Step 2: Calculate the total revised budget for the first rows defined in the dataset
# Sum the Revised Budget from both gf_first_rows and gf_remaining_rows
total_projections_sg <- sum(as.numeric(sg_first_rows$`Revised Budget`), na.rm = TRUE) + 
                        sum(as.numeric(sg_remaining_rows$`Revised Budget`), na.rm = TRUE)


# Step 3: Create the stacked horizontal bar chart with two threshold lines
ggplot(pcnt_final_data, aes(x = Category, y = Value, fill = Category)) +
  geom_bar(stat = "identity", position = "dodge") +  # Side-by-side bars (non-stacked)
  labs(title = "Percentage of Budget Depleted YTD Comparisons",
       subtitle = "1001 General Funds and 5000 State Grant Funds",
       x = "Category", y = "Percentage (%)") +
  coord_flip()+
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +  # Format y-axis labels as percentages
  scale_fill_manual(values = c("Total Salaries" = "#004D40", 
                               "Total Expenses" = "#1E88E5", 
                               "Overall Total" = "#5D3A9B")) +  # Custom colors for each category
  theme_minimal() +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 14),  # Increase legend text size
        plot.title = element_text(hjust = 0.5, size = 16),  # Increase plot title size
        plot.subtitle = element_text(hjust = 0,size = 12),
        axis.title.x = element_text(size = 14, face = "bold" ),  # Increase x-axis title size
        axis.title.y = element_text(size = 14, face = "bold"),  # Increase y-axis title size
        axis.text.x = element_text(size = 14),  # Increase x-axis labels size
        axis.text.y = element_text(size = 14))  # Increase y-axis labels size


# save the plot
ggsave("Charts/pct_tbl.png",width = 18, height = 16, dpi = 300)  
```


*Fifth table compares the Remaining Balance, Sur/ Def, and Projected Y|E Value for the Analysis table General Fund 1001*

### Remaining Balance, Sur/ Def, and Projected Y|E Value for the Analysis table General Fund 1001 comparison plot
The plot below will compare the Analysis table General Fund data together. The `ays_gf_comparison_data` includes the spending categories that are within the 1001 General Grants. This will show which if the budget is close or over for the total overall budget of the spending categories. 


```{r anlys_gf_plot, warning=FALSE}
# Create the comparison data for plotting
ays_gf_comparison_data <- data.frame(
  Category = rep(c("Salaries/OPC Projections", "Other EXP Projections"), each = nrow(alysgf_summary)),  
  Fund = rep(c("1001 General Grants Fund"), each = nrow(alysgf_summary)),  
  Value = c(
    rowSums(replace(alysgf_summary[, c("Remaining Balance - Salaries/OPC", "Projected YE Value - Salaries/OPC", 
                                       "Sur/(Def) - Salaries/OPC")], is.na(alysgf_summary[, c("Remaining Balance - Salaries/OPC", 
                                                                                            "Projected YE Value - Salaries/OPC", 
                                                                                            "Sur/(Def) - Salaries/OPC")]), 0)),  
    rowSums(replace(alysgf_summary[, c("Projected YE Value - Other EXP", "Sur/(Def) - Other EXP")], 
                    is.na(alysgf_summary[, c("Projected YE Value - Other EXP", "Sur/(Def) - Other EXP")]), 0))
  )
)

# Step 2: Create the non-stacked horizontal bar chart with custom colors and bold axis titles
ggplot(ays_gf_comparison_data, aes(x = Category, y = Value, fill = Category)) +
  geom_bar(stat = "identity", position = "dodge") +  # Non-stacked bars (side-by-side)
  scale_fill_manual(values = c("Salaries/OPC Projections" = "steelblue", 
                               "Other EXP Projections" = "darkgreen")) +  # Custom colors
  scale_y_continuous(labels = label_dollar()) +  # Format y-axis values with dollar signs and commas
  coord_flip()+
  labs(title = "Analysis Table 1001 General Grant Funds Comparisons",
       subtitle = "1001 General Funds",
       x = "Category",
       y = "Amount") +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 14),
    plot.subtitle = element_text(hjust = 0, size = 12),
    plot.title = element_text(hjust = 0.5, size = 16),
    axis.title.x = element_text(size = 14, face = "bold"),  # Bold x-axis title
    axis.title.y = element_text(size = 14, face = "bold"),  # Bold y-axis title
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1),  # Rotate x-axis labels
    axis.text.y = element_text(size = 12)
  )

# save the plot
ggsave("Charts/ays_gf_comparison_data.png",width = 18, height = 16, dpi = 300)  
```


<<<<<<< HEAD
####
### Creating the Excel workbooks
####

## Create the Excel workbooks for wb1 and wb2
Creating wb1 for the summer food program and wb2 for the analysis table.
=======
 
*Sixth table compares the Remaining Balance, Sur/ Def, and Projected Y|E Value for the Analysis Other Funds - 2089, 4000, and 5000 table*
>>>>>>> 8489e411ef92aaf03edb99dd2480afbf8b440db0

### Remaining Balance, Sur/ Def, and Projected Y|E Value for the Analysis Other Funds - 2089, 4000,  and 5000 table plot
The plot below will compare the Analysis table General Fund data together. The `ays_sg_comparison_data` includes the spending categories that are within the 5000 State Grants Fund. This will show which if the budget is close or over for the total overall budget of the spending categories. 


<<<<<<< HEAD
###
## Styling for the Excel workbooks
This will create the styling for the 2 wbs. The Summer Food Program and the Analysis Table.
*NOTE: You do NOT need to change the name of the title header for the tables. As the function in line 294 will automatically detect the fiscal year end or begining date and apply the month/day to the header (line 304)*

```{r stylingforwb1}
# --- get the current system date when this was run ---

current_date <- Sys.Date()

# extract year and month
current_year <- format(current_date, "%Y")
current_month <- as.numeric(format(current_date, "%m"))


# Determine the fiscal year
if (current_month >= 7) {
  fiscal_year <- as.numeric(current_year) + 1
} else {
  fiscal_year <- as.numeric(current_year)
}

# --- create a workbook ---

# format the title header 

title_header <- paste0("FY ", fiscal_year, " Budget and Actual as of ", format(current_date, "%m/%d/%Y"))

# add the worksheet to the created workbook
wb1 <- createWorkbook()
addWorksheet(wb1, "Summer Expense Report")

# --- add Title Header (Row 1) ---

# creating a title header 
writeData(wb1, "Summer Expense Report", title_header, startRow = 1, startCol = 1)
header_style <- createStyle(halign = "center", valign = "center", textDecoration = "bold", fgFill = "#ED7D31")

# merge the cells for the title
mergeCells(wb1, "Summer Expense Report", cols = 1:ncol(summer_expense_rep), rows = 1)
addStyle(wb1, "Summer Expense Report", header_style, rows = 1, cols = 1:ncol(summer_expense_rep), gridExpand = TRUE)

# --- write the Data (Row 2) with Column Names ---

writeData(wb1, "Summer Expense Report", summer_expense_rep, startRow = 2, startCol = 1, colNames = TRUE)

# --- align for Column Headers (Row 2) ---

center_style <- createStyle(halign = "center", valign = "center")
addStyle(wb1, "Summer Expense Report", center_style, rows = 2, cols = 1:ncol(summer_expense_rep), gridExpand = TRUE)

# --- style the Column Names (Row 2) ---

column_names_style <- createStyle(
  halign = "center", 
  valign = "center", 
  textDecoration = "bold", 
  fgFill = "#ED7D31" 
)

# apply the style to the column names (row 2)
addStyle(wb1, "Summer Expense Report", column_names_style, rows = 2, cols = 1:ncol(summer_expense_rep), gridExpand = TRUE)

# --- saving the wb ---
saveWorkbook(wb1, "summer_expense_report.xlsx", overwrite = TRUE)
```


Styling for the 2 wb or Analysis table.
=======
```{r anlys_gf_plot, warning=FALSE}
# Create the comparison data for plotting
ays_sg_comparison_data <- data.frame(
  Category = rep(c("Salaries/OPC Projections", "Other EXP Projections"), each = nrow(alysg_summary)),  
  Fund = rep(c("5000 State Grants Fund"), each = nrow(alysg_summary)),  
  Value = c(
    rowSums(replace(alysg_summary[, c("Remaining Balance - Salaries/OPC", "Projected YE Value - Salaries/OPC", 
                                       "Sur/(Def) - Salaries/OPC")], is.na(alysg_summary[, c("Remaining Balance - Salaries/OPC", 
                                                                                            "Projected YE Value - Salaries/OPC", 
                                                                                            "Sur/(Def) - Salaries/OPC")]), 0)),  
    rowSums(replace(alysg_summary[, c("Projected YE Value - Other EXP", "Sur/(Def) - Other EXP")], 
                    is.na(alysg_summary[, c("Projected YE Value - Other EXP", "Sur/(Def) - Other EXP")]), 0))
  )
)

# Step 2: Create the non-stacked horizontal bar chart with custom colors and bold axis titles
ggplot(ays_sg_comparison_data, aes(x = Category, y = Value, fill = Category)) +
  geom_bar(stat = "identity", position = "dodge") +  # Non-stacked bars (side-by-side)
  scale_fill_manual(values = c("Salaries/OPC Projections" = "steelblue", 
                               "Other EXP Projections" = "darkgreen")) +  # Custom colors
  scale_y_continuous(labels = label_dollar()) +  # Format y-axis values with dollar signs and commas
  coord_flip()+
  labs(title = "Analysis Table Other Funds - 2089, 4000, and 5000 Comparisons",
        subtitle = "5000 State Grant Funds",
       x = "Category",
       y = "Amount") +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 16),
    plot.subtitle = element_text(hjust = 0,size = 12),
    axis.title.x = element_text(size = 14, face = "bold"),  # Bold x-axis title
    axis.title.y = element_text(size = 14, face = "bold"),  # Bold y-axis title
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1),  # Rotate x-axis labels
    axis.text.y = element_text(size = 12)
  )

# save the plot
ggsave("Charts/ays_sg_comparison_data.png",width = 18, height = 16, dpi = 300)  
```

>>>>>>> 8489e411ef92aaf03edb99dd2480afbf8b440db0


*Seventh table compares the Remaining Balance, Sur/ Def, and Projected Y|E Value for the Analysis Total Projections equals to row 268 table*

### Remaining Balance, Sur/ Def, and Projected Y|E Value for the Analysis Total Projections equals to row 268 plot
The plot below will compare the Analysis table General Fund data together. The `aystpe_comparison_data` includes the spending categories that are within the 1001 General Grants. This will show which if the budget is close or over for the total overall budget of the spending categories. 


```{r anlys_tpe_plot, warning=FALSE}
# Create the comparison data for plotting
aystpe_comparison_data <- data.frame(
  Category = rep(c("Salaries/OPC Projections", "Other EXP Projections"), 
                 each = nrow(alysgf_final_tbl) + nrow(alysg_final_tbl)),  # Adjusting replication
  
  Fund = c(rep("1001 General Grants Fund", nrow(alysgf_final_tbl)), 
           rep("GL YTD EXP 1001 General Grants Fund", nrow(alysg_final_tbl)), 
           rep("1001 General Grants Fund", nrow(alysgf_final_tbl)), 
           rep("GL YTD EXP 5000 State Grants Fund", nrow(alysg_final_tbl))),  # Assigning funds correctly
  
  Value = c(alysgf_final_tbl$`Salaries/OPC Projections`, 
            alysg_final_tbl$`Salaries/OPC Projections`, 
            alysgf_final_tbl$`Other EXP Projections`, 
            alysg_final_tbl$`Other EXP Projections`)  # Matching values correctly
)


# Step 2: Create the non-stacked horizontal bar chart with custom colors and bold axis titles
ggplot(aystpe_comparison_data, aes(x = Category, y = Value, fill = Category)) +
  geom_bar(stat = "identity", position = "dodge") +  # Non-stacked bars (side-by-side)
  scale_fill_manual(values = c("Salaries/OPC Projections" = "steelblue", 
                               "Other EXP Projections" = "darkgreen")) +  # Custom colors
  scale_y_continuous(labels = label_dollar()) +  # Format y-axis values with dollar signs and commas
  coord_flip()+
  labs(title = "Analysis Table Total Projections Equals to Row 268 Comparisons",
       subtitle = "1001 General Funds and 5000 State Grant Funds",
       x = "Category",
       y = "Amount") +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    legend.text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 16),
    plot.subtitle = element_text(hjust = 0,size = 12),
    axis.title.x = element_text(size = 14, face = "bold"),  # Bold x-axis title
    axis.title.y = element_text(size = 14, face = "bold"),  # Bold y-axis title
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1),  # Rotate x-axis labels
    axis.text.y = element_text(size = 12)
  )

<<<<<<< HEAD
saveWorkbook(wb2, "analysis_tbl.xlsx", overwrite = TRUE)
```


###
## Combining the workbooks
Last step, "Whew!", is to join the two of these workbooks together to have 1 full working workbook that can be used for the team. 

```{r combiningwbs}
# --- combine the two workbooks on the same worksheet with full formatting ---

# create a new workbook
wb_combined <- createWorkbook()

# add a worksheet for the combined data
addWorksheet(wb_combined, "tables_unite")

# define styles for titles and headers
title_style_summer <- createStyle(halign = "center", valign = "center", textDecoration = "bold", fgFill = "#FFA500")
title_style_analysis <- createStyle(halign = "center", valign = "center", textDecoration = "bold", fgFill = "#C6E0B4")
header_style_summer <- createStyle(halign = "center", valign = "center", textDecoration = "bold", fgFill = "#FFA500")
header_style_analysis <- createStyle(halign = "center", valign = "center", textDecoration = "bold", fgFill = "#C6E0B4")

# write the Summer Expense Report table with title and formatting
writeData(wb_combined, "tables_unite", "Summer Expense Report", startRow = 1, startCol = 1)
mergeCells(wb_combined, "tables_unite", cols = 1:ncol(summer_expense_rep), rows = 1)
addStyle(wb_combined, "tables_unite", title_style_summer, rows = 1, cols = 1:ncol(summer_expense_rep), gridExpand = TRUE)
writeData(wb_combined, "tables_unite", summer_expense_rep, startRow = 2, startCol = 1, colNames = TRUE)
addStyle(wb_combined, "tables_unite", header_style_summer, rows = 2, cols = 1:ncol(summer_expense_rep), gridExpand = TRUE)

# add a blank space between the tables (2 columns of empty cells)
num_rows_summer <- nrow(summer_expense_rep)
writeData(wb_combined, "tables_unite", matrix("", nrow = num_rows_summer + 2, ncol = 2), startRow = 1, startCol = ncol(summer_expense_rep) + 1, colNames = FALSE)

# write the Analysis Table with title and formatting
writeData(wb_combined, "tables_unite", "Analysis Table", startRow = 1, startCol = ncol(summer_expense_rep) + 3)
mergeCells(wb_combined, "tables_unite", cols = (ncol(summer_expense_rep) + 3):(ncol(summer_expense_rep) + 2 + ncol(analysis_tbl)), rows = 1)
addStyle(wb_combined, "tables_unite", title_style_analysis, rows = 1, cols = (ncol(summer_expense_rep) + 3):(ncol(summer_expense_rep) + 2 + ncol(analysis_tbl)), gridExpand = TRUE)
writeData(wb_combined, "tables_unite", analysis_tbl, startRow = 2, startCol = ncol(summer_expense_rep) + 3, colNames = TRUE)
addStyle(wb_combined, "tables_unite", header_style_analysis, rows = 2, cols = (ncol(summer_expense_rep) + 3):(ncol(summer_expense_rep) + 2 + ncol(analysis_tbl)), gridExpand = TRUE)

# save the final workbook
# the file will automatically assign a date to the workbook
# add a space in the file output as well to ensure the data is not all bundled up

saveWorkbook(wb_combined, paste0("FY ", fiscal_year, " Budget and Actual as of ", format(current_date, "%m-%d-%Y"), ".xlsx"), overwrite = TRUE)
```


#### YOU DID IT ####
Congratulations! You did a wonderful job coding! 
If this is your first real coding r markdown file, then I must say you choose a tricky assignment. 
Go ahead and call yourself a Rstudio programmer you data analyst!
#### YOU DID IT ####
=======
# save the plot
ggsave("Charts/ays_tpe_comparison_data.png",width = 18, height = 16, dpi = 300)  
```





























































































































>>>>>>> 8489e411ef92aaf03edb99dd2480afbf8b440db0


