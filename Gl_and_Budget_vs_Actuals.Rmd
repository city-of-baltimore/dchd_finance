---
title: "Gl_and_Budget_vs_Actuals"
author: "Selenea Gibson & Jason Howard"
date: "2025-01-02"
output: html_document
---

## Project Overview
This markdown file will use the DHCD Finance dept documents that are for reporting expenditures and GL data. The data is collected from Workday.

```{r libraries}
# libraries for data analysis
library(dplyr)
library(here)
library(tidyverse)
library(scales)
library(DT)
library(openxlsx)
library(stringr)
library(lubridate)
```

## Reading in the data 
Reading in the files for the data that will be used. Put new data files in the "Data" folder and replace the file names below with the names of the new files.

```{r data}
# change the names of these files to represent the newest file downloaded
gl_file_name <- "GL-Operating Actual Expenses YTD 2024-12-19 13_03 EST.xlsx"

budg_vs_act_file_name <- "Budget_vs_Actuals_-_BBMR YTD 2024-12-19.xlsx"
 
# read data from files
gl_data <- readxl::read_xlsx(here("Data", gl_file_name), 
                             skip = 13,
                             col_types = c(rep("text",2),   
                                           "date", 
                                           rep("text",6),
                                           rep("numeric", 3),
                                           rep("text",26)))


# The first row of the data file is mostly empty except for a few important dates. 
# Read those data and do some formatting to clean up the data.
first_row_of_data <- readxl::read_xlsx(here("Data", budg_vs_act_file_name)) |> 
  names() 

# Should this be first row? As the column_names is not defined?
name_prefixes <- tibble(first_row_of_data) |> 
  mutate(prefixes = ifelse(str_detect(first_row_of_data, "\\.\\."), 
                          NA_character_, 
                          first_row_of_data)) |> 
fill(prefixes, .direction = "down") |> 
  pull(prefixes)

# read the data file again but skip the first line
budg_vs_actuals <- readxl::read_xlsx(here("Data", budg_vs_act_file_name),
                  skip = 1)

#dropping the total budget row as this is not needed and will mess up the data
budg_vs_actuals <- budg_vs_actuals |> 
  filter(`Cost Center` != "Total")

# the names in the file repeat themselves, but this combines the dates with the repetative names
for(i in seq_along(name_prefixes)){
  plain_name <- gsub("\\.\\..*","", names(budg_vs_actuals)[i]) 
  
  names(budg_vs_actuals)[i] <- 
    ifelse(is.na(name_prefixes[i]) & str_length(plain_name) > 0,
           plain_name,
           paste(plain_name,name_prefixes[i], sep = "_"))
}

 names(budg_vs_actuals)
```

## Cleaning the datasets
I need to remove some of the rows that are not needed for the analysis. I will then make the new row be the header row. 

```{r cleaningdata}
# add round all expenditure days to the expenditure month
gl_data <- gl_data |> 
  mutate(expend_month = as.Date(floor_date(`Accounting Date` , unit = "month")))

# remove columns that have nulls for all values, replace "blank" with an actual 'null' value
budg_vs_actuals <- budg_vs_actuals |> 
  select_if(~sum(!is.na(.)) > 0) |> 
  mutate(Grant = ifelse(Grant == "(Blank)", NA_character_, Grant))

#create a dataframe of overall expenditures by worktags from the budget vs actuals file
budg_vs_actuals_overall <- 
  budg_vs_actuals |> 
  select(-matches("_")) 

# create a dataframe of monthly expenditures by worktags from the  budget vs actuals file. Change the table from wide to long.
budget_vs_Actuals_monthly <- 
  budg_vs_actuals |> 
  select(-matches("Budget|total",ignore.case = T)) |> 
  pivot_longer(cols = -!matches("_"), names_to = "date_topic", values_to = "amounts") |> 
  separate(date_topic, sep = "_", into = c("acct_category", "month")) |> mutate(month = as.Date(paste0(month,"-01")))
```

## Monthly amounts match
Check to see if the monthly expenditures for each categories match between the two files.

```{r monthlyamnts}
# aggregate the ledger data by month and worktags
monthly_spendies <- gl_data |> 
  group_by(expend_month, Fund, `Cost Center`, Grant, 
           `Spend Category as Worktag`) |> 
  reframe(total_spend_on_gl = sum(Amount, na.rm = T))

# compare between two files
monthly_spendies_compared <- budget_vs_Actuals_monthly |> 
  filter(acct_category == "Actuals") |> 
  full_join(monthly_spendies, by = c("Cost Center"="Cost Center",
                                     "Fund"="Fund",
                                     "Grant" = "Grant",
                                     "Spend Category" = "Spend Category as Worktag",
                                     "month"="expend_month")) 

# filter on those where values dont match
mismatched_monthly_expenditures <- monthly_spendies_compared |> 
  filter(round(amounts) != round(total_spend_on_gl) ) 

# creating a message to show the number of mismatched rows
message(scales::percent(nrow(mismatched_monthly_expenditures)/nrow(monthly_spendies_compared), accuracy = .1), " of rows are mismatched")

# message states that .6% of rows are mismatched
```

## Overall expenditures
Check to see if the total expenditures for each category match between the two files.

```{r match}
# creating new dataset from the gl_data
overall_spendies <- gl_data |> 
  group_by(Fund, `Cost Center`, Grant, `Spend Category as Worktag`) |> 
  reframe(total_spend_on_gl = sum(Amount, na.rm = T),
          number_of_lines = n())

# joining the budg vs. actual overall data to the overall spendies
overall_spendies_compared <- budg_vs_actuals_overall |> 
    full_join(overall_spendies, by = c("Cost Center"="Cost Center",
                                     "Fund"="Fund",
                                     "Grant" = "Grant",
                                     "Spend Category" = "Spend Category as Worktag")) 

# rounding the total spent and filtering the data to match the variables of the total column
mismatched_overall_expenditures <- overall_spendies_compared |> 
  filter(round(`Total Spent` ) != round(total_spend_on_gl) ) |> 
  mutate_at(vars(matches("total", ignore.case = T)), scales::dollar)

# creating a message to show the number of rows that are mismatched
message(scales::percent(nrow(mismatched_overall_expenditures)/nrow(overall_spendies), accuracy = .1), " are mismatched")

# large amount of mismatches with the data being different for the overall expenditures. 
# 7.8% are different.
```

## Making an output table
This will create the table that can be used for `754 SFSP Expense Report`. Ideally we want to keep the pre-existing data but make placeholders for data that we do not currently have for specific months. What we can do is make placeholders for the data and then we can tweak it as we go.

```{r outputtable}
# for now I am using the tot_actual cat - I cannot figure out where they are getting this total bud from

# define all months expected in the report (Jan - Dec)
expected_months <- month.name

# create the expense report table, including the main columns and data
expense_report_tbl <- budg_vs_actuals |> 
  reframe(
    'Service Name' = Service,
    Fund = Fund,
    'Cost Center Name' = `Cost Center`,
    'Spend Category' = `Spend Category`,
    'Total Budget' = `Total Actuals`, # again this is a placeholder until I find the right column
    `Actuals_2024-07` = ifelse(is.na(`Actuals_2024-07`), "", `Actuals_2024-07`),
    `Actuals_2024-08` = ifelse(is.na(`Actuals_2024-08`), "", `Actuals_2024-08`),
    `Actuals_2024-09` = ifelse(is.na(`Actuals_2024-09`), "", `Actuals_2024-09`),
    `Actuals_2024-10` = ifelse(is.na(`Actuals_2024-10`), "", `Actuals_2024-10`),
    `Actuals_2024-11` = ifelse(is.na(`Actuals_2024-11`), "", `Actuals_2024-11`),
    `Actuals_2024-12` = ifelse(is.na(`Actuals_2024-12`), "", `Actuals_2024-12`),
  )

# Apply transformations to the existing month columns
expense_report_tbl <- expense_report_tbl %>%
  mutate(across(
    .cols = starts_with("Actuals_2024-"),  # Apply only to month columns
    .fns = ~ ifelse(is.na(.), "", .),  # Replace NAs with empty string
    .names = "{.col}"  # Keep original month names
  ))

# check it out and see how it looks
print(expense_report_tbl)

# rename the columns for easier reading
expense_report_tbl <- expense_report_tbl |> 
  rename(July = `Actuals_2024-07`,
         August = `Actuals_2024-08`,
         September = `Actuals_2024-09`,
         October = `Actuals_2024-10`,
         November = `Actuals_2024-11`,
         December = `Actuals_2024-12`)

# create the GL YTD EXP column which is taking the previous month and dividing by the current month
# change the date of the month in the divison for what the month pertains to so if it is 
# aug then make it aug then do july/aug for the column. 
expense_report_tbl <- expense_report_tbl |> 
  mutate(
    'GL YTD EXP' = ifelse(
      !is.na(August & August!= 0 & !is.na(July) & July!= 0),  # Ensure non-zero and non-NA denominator and numerator
      lag(August) / July,  # Perform division
      NA  # Return NA if July or August is NA or zero
    )
  ) |> 
  mutate(
    'GL YTD EXP' = ifelse(
      is.finite(`GL YTD EXP`),  # Check if the value is finite (not Inf or NaN)
      round(`GL YTD EXP`, 2),   # Round to 2 decimal places to avoid exponential notation
      ""  # Return NA for non-finite values
    )
  )
```

###
## Create the Excel workbook
Now I will create the workbook that will be used to display the data that is seen on the `754 SFSP Expense Report`. 

I am going to break it up in steps to follow it easier.

1. I want to put all of the service data into a dataset that will have everything in it.
2. I want to filter the data to only be focused on the Summer Food Service Program.
3. I want to sort by the Fund column. 

```{r filteringsumprogram}
# group the data by Service Name and arrange by Spend Category
all_expense_rep <- expense_report_tbl |> 
  arrange(`Service Name`, `Spend Category`) |> 
  select(c(`Service Name`,
            Fund, 
           `Cost Center Name`,
           `Spend Category`, 
           `Total Budget`,
           July,
           August,
           September,
           October,
           November,
           December,
          `GL YTD EXP`))

# filter to show the summer_food_program only have to put the full name into the filter
summer_expense_rep <- all_expense_rep |> 
  filter(`Service Name` == "SRV0754 Summer Food Service Program")

# sort data and arrange by the Fund name to show the 1001 General Fund first
summer_expense_rep <- summer_expense_rep |> 
  arrange(Fund, `Service Name`, `Spend Category`)
```

4. Creating the workbook.
There is a lot going on here. So what this section is doing is creating the workbook but in sections. 

```{r workbook}
# --- identifying the first row for the data ---

# find the first row of "1001 General Fund", "5000 State Grants Fund", and the "CCA000347 Summer Food Service Program"
first_row_sfp <- which(tolower(summer_expense_rep$`Service Name`) == tolower("SRV0754 Summer Food Service Program")) |> 
  min()
first_row_1001gf <- which(tolower(summer_expense_rep$Fund) == "1001 general fund") |>
  min()
first_row_5000sf <- which(tolower(summer_expense_rep$Fund) == "5000 state grants fund") |>
  min()
first_row_ccn <- which(tolower(summer_expense_rep$`Cost Center Name`) == tolower("CCA000347 Summer Food Service Program")) |> 
  min()

# --- create a workbook ---

# add the worksheet to the created workbook
wb <- createWorkbook()
addWorksheet(wb, "Summer Expense Report")

# --- add Title (Row 1) ---

# add a header, style, and color with the label "Summer Analysis" in the first row
writeData(wb, "Summer Expense Report", "FY 2024 Budget and Actual as of 07/31/2024", startRow = 1, startCol = 1)
header_style <- createStyle(halign = "center", valign = "center", textDecoration = "bold", fgFill = "#FFA500")
mergeCells(wb, "Summer Expense Report", cols = 1:ncol(summer_expense_rep), rows = 1)
addStyle(wb, "Summer Expense Report", header_style, rows = 1, cols = 1:ncol(summer_expense_rep), gridExpand = TRUE)

# --- align for column headers ---

# center alignment for column headers
center_style <- createStyle(halign = "center", valign = "center")
addStyle(wb, "Summer Expense Report", center_style, rows = 2, cols = 1:ncol(summer_expense_rep), gridExpand = TRUE)

# --- identify after first appearance ---

# reset "Service Name", "Fund", and "Cost Center Name" after first appearance
summer_expense_rep$`Service Name` <- ""
summer_expense_rep$Fund <- ""
summer_expense_rep$`Cost Center Name` <- ""

# --- assign first appearance ---

# ensure first appearance of each section is retained
summer_expense_rep$`Service Name`[first_row_sfp] <- "SRV0754 Summer Food Service Program"

summer_expense_rep$Fund[first_row_1001gf] <- "1001 General Fund"

summer_expense_rep$Fund[first_row_5000sf] <- "5000 State Grants Fund"

summer_expense_rep$`Cost Center Name`[first_row_ccn] <- "CCA000347 Summer Food Service Program"

# --- add blank rows ---

# add blank rows after each section
writeData(wb, "Summer Expense Report", matrix("", nrow = 1, ncol = ncol(summer_expense_rep)), 
          startRow = first_row_1001gf + 2, colNames = FALSE)

writeData(wb, "Summer Expense Report", matrix("", nrow = 1, ncol = ncol(summer_expense_rep)), 
          startRow = first_row_5000sf + 2, colNames = FALSE)

writeData(wb, "Summer Expense Report", matrix("", nrow = 1, ncol = ncol(summer_expense_rep)), 
          startRow = first_row_ccn + 2, colNames = FALSE)

# --- write Data and Format Sections ---

# write data before each blank row
writeData(wb, "Summer Expense Report", summer_expense_rep[1:first_row_1001gf, ], colNames = TRUE, startRow = 2)
writeData(wb, "Summer Expense Report", summer_expense_rep[(first_row_1001gf + 1):first_row_5000sf, ], 
          startRow = first_row_1001gf + 3, colNames = FALSE)
writeData(wb, "Summer Expense Report", summer_expense_rep[(first_row_5000sf + 1):first_row_ccn, ], 
          startRow = first_row_5000sf + 3, colNames = FALSE)

# --- write the rest of the data ---

# write remaining data after the last section
writeData(wb, "Summer Expense Report", summer_expense_rep[(first_row_ccn + 1):nrow(summer_expense_rep), ], 
          startRow = first_row_ccn + 3, colNames = FALSE)
```

6. Analysis Table
Here I am working to create the second table that is in the `754 SFSP Expense Report`. 

```{r analysistbl}
# clean and calculate with blanks for NA values
summer_expense_rep <- summer_expense_rep |> 
  mutate(
    `Total Budget` = as.numeric(gsub("[^0-9.]", "", `Total Budget`)),
    `GL YTD EXP` = as.numeric(gsub("[^0-9.]", "", `GL YTD EXP`)),
    `Remaining Balance` = ifelse(is.na(`GL YTD EXP`), "", `Total Budget` - `GL YTD EXP`)
  )
```

7. Saving the workbook
Here I am writing and saving the workbook

```{r writewb}
# save the workbook
saveWorkbook(wb, "FY_2024_Budget_and_Actual_as_of_07/31/2024.xlsx", overwrite = TRUE)
```


















#####
####
### Plots
Making some plots that show different perspectives on the budgets vs. actuals.

## Negative Spending
The plot below will show negative spending for service types vs. total spent.

```{r totspentnegplot}
# remove the leading numbers before the service name for plotting 
budg_vs_actuals <- budg_vs_actuals |> 
  mutate(Service = sub("^\\S+\\s*", "", Service))

# filter the dataset for negative spending values
negative_spending <- budg_vs_actuals|> 
  filter(`Total Spent` < 0)

# plotting data below for different perspectives
tot_neg_spending <- ggplot(negative_spending, aes(x = Service, y = `Total Spent`)) +
  geom_col(fill = "red") +  # Bar plot with red bars for negative values
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Services with Negative Spending", 
       x = "Service", 
       y = "Total Spent") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 20),  # Adjust x-axis text size
    axis.text.y = element_text(size = 20),  # Adjust y-axis text size
    axis.title.x = element_text(size = 22),  # Adjust x-axis title size
    axis.title.y = element_text(size = 20),  # Adjust y-axis title size
    plot.title = element_text(size = 25, hjust = 0.5)  # Adjust plot title size
  )

# viewing the plot
tot_neg_spending

# saving the plot
ggsave("plots/tot_neg_spending.pdf",
       width = 40, height = 20)
```

## July Actual Spending
The plot below will show spending for service types and July actual spent.

```{r julyplot}
# Create a plot showing Actuals spent for July by Service with positive (blue) and negative (red) bars
july_spending_plot <- ggplot(budg_vs_actuals, aes(x = Service, y = `Actuals_2024-07`, fill = `Actuals_2024-07` > 0)) +
  geom_col() +  # Create bars
  scale_fill_manual(values = c("red", "blue"), 
                    labels = c("Negative", "Positive")) +  # Custom legend labels
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +  # Format y-axis to show real values
  labs(title = "Actual Spending for July by Service", 
       x = "Service", 
       y = "Actuals Spent (July 2024)") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 20),  # X-axis text size
    axis.text.y = element_text(size = 22),  # Y-axis text size
    axis.title.x = element_text(size = 20),  # X-axis title size
    axis.title.y = element_text(size = 20),  # Y-axis title size
    plot.title = element_text(size = 24, hjust = 0.5),  # Plot title size
    legend.title = element_blank(),  # Remove legend title
    legend.text = element_text(size = 24),  # Increase legend text size
    legend.key.size = unit(1.5, "lines")  # Increase the size of the legend key (color box)
  )

# Print the plot
print(july_spending_plot)

# saving the plot
ggsave("plots/july_spending_plot.pdf",
       width = 30, height = 20)
```






## Example code below

# the code below will read a Payroll Expense Ledger report
# from workday and create a summary excel file and a couple charts

# these will load a couple additional R tools for the work
# libraries are extra R tools

```{r libraries}
library(tidyverse)
library(ggplot2)
```

## Reading the expenditure data
This will read the excel file. The file needs to be in the same folder as the R script. And the name in parenthesis needs to match the file name of the excel file.

```{r expendata}
expenditure_data <-
  readxl::read_xlsx("June Payroll Expense Ledger by Org Excel 2024-07-17 10_21 EDT.xlsx",
                    skip = 8)
```

## Aggregating and summing the expenditures
This part aggregates the transaction in the GL file by service then sums the expenditures.

```{r groupby}
service_exp <- expenditure_data |>
  group_by(`Service (Cost Center Hierarchy)`) |>
  summarise(total_expenditures = sum(`Ledger Amount ($)`)) |>
  ungroup() |>
  arrange(desc(total_expenditures))
```

## Creating an object
You just created an object called "service_exp" which can be seen be executing this.

```{r print}
print(service_exp)
```

## Aggregating the GL file by cost center
This part aggregates the transaction in the GL file by cost center then sums the expenditures.

```{r aggregates}
cost_center_exp <- expenditure_data |>
  group_by(`Cost Center`) |>
  summarise(total_expenditures = sum(`Ledger Amount ($)`)) |>
  ungroup() |>
  arrange(desc(total_expenditures))
```

## Creating an object 
you just created an object called "cost_center_exp" which can be seen be executing this.

```{r object}
cost_center_exp
```

## Writing out the costcenter and the expenitures to an excel file 
This part creates an excel file with the cost center and service expenditures.

```{r write_excel_file}
writexl::write_xlsx(list(`expend by service` = service_exp,
                         `expend by cost center` = cost_center_exp), "summarized_expenditures.xlsx")
```


## Aggregating the data
This part aggregates by date posted, summing expenditures by the day the posted to the GL.

```{r sums}
daily_spend <- expenditure_data |>
  mutate(day = floor_date(as.Date(`Accounting Date` ), "day")) |>
  group_by(day) |>
  summarise(total_expenditures = sum(`Ledger Amount ($)`)) |>
  ungroup()

print(daily_spend)
```

## Making the Chart
This part makes the chart using columns from the daily_spend dataframe.

```{r charts}
daily_spend |>
  ggplot(aes(day, total_expenditures))+
  geom_col() +
  theme_classic() +
  scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6)) +
  geom_hline(yintercept=0) +
  labs(title = "DGS Posted Expenditures throughout the month of June 2024",
       subtitle = "Expenditures by day",
       y = "Expenditures ($)",
       x = "Date posted on GL")
```

## Saving the chart 
This part saves the chart.

```{r savingchart}
ggsave("daily_spend.pdf",
       width = 8, height = 5)
```


## Aggregates 
This part aggregates bby fund, summing expenditures, then makes a chart.

```{r exped_plot}
expenditure_data |>
  separate(Fund, into = c("number", "Fund"), extra = "merge", remove = T) |>
  group_by(Fund) |>
  summarise(total_spend = sum(`Ledger Amount ($)`)) |>
  ggplot(aes(reorder(Fund, (total_spend)), total_spend)) +
  geom_col(fill = "orange") +
  theme_classic() +
  coord_flip() +
  scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6), expand = c(0, 0), limits = c(0,3000000))+
  labs(title = "DGS Posted Expenditures by Fund",
       subtitle = "Posted in June 2024",
       y = "Expenditures ($)",
       x = "")
```

## Saving the chart as PDF
This saves the chart as a pdf.

```{r savingplot}
ggsave("spend_by_fund.pdf",
       width = 8.5, height = 5)
```

## Filtering  
This part filters transaction to the manual JEs then aggregates by by fund summing the GL transactions by the fund.

```{r filters}
manual_change_data <- expenditure_data |>
  filter(str_detect(`Journal Source`, "Manual")) |>
  separate(Fund, into = c("number", "Fund"), extra = "merge", remove = T) |>
  group_by(Fund) |>
  summarise(total_spend = sum(`Ledger Amount ($)`))
```

## Chart for manual GL's 
This part makes the chart showing where the manual GL's occur.

```{r ggplot}
ggplot() +
  geom_col(data = manual_change_data,
           mapping = aes(reorder(`Fund`, (total_spend)), total_spend),
           fill = "orange") +
  geom_text(data = manual_change_data,
            mapping = aes(reorder(`Fund`, (total_spend)), 0,
                          label = scales::dollar(total_spend/1000000, suffix = "M")), hjust = -.2) +
  theme_classic() +
  geom_hline(yintercept=0) +
  coord_flip() +
  geom_text() +
  scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6), expand = c(0, 0))+
  labs(title = "Manual Accounting Adjustments",
       subtitle = "Made in June 2024",
       y = "Expenditures ($)",
       x = "")

```

## Saving the chart to PDF format
This saves the chart as a pdf.

```{r ggsave}
ggsave("manual_adjustments_by_fund.pdf",
       width = 8.5, height = 5)
```


















