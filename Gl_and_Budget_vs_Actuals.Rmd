---
title: "Gl_and_Budget_vs_Actuals"
author: "Selenea Gibson & Jason Howard"
date: "2025-01-02"
output: html_document
---

## Project Overview
This markdown file will use the DHCD Finance dept documents that are for reporting expenditures and GL data. The data is collected from Workday.

```{r libraries}
# libraries for data analysis
library(dplyr)
library(here)
library(tidyverse)
library(scales)
library(DT)
library(openxlsx)
library(stringr)
library(lubridate)
```

## Reading in the data 
Reading in the files for the data that will be used. Put new data files in the "Data" folder and replace the file names below with the names of the new files.

```{r data}
# change the names of these files to represent the newest file downloaded
gl_file_name <- "GL-Operating Actual Expenses YTD 2024-12-19 13_03 EST.xlsx"

budg_vs_act_file_name <- "Budget_vs_Actuals_-_BBMR YTD 2024-12-19.xlsx"
 
# read data from files
gl_data <- readxl::read_xlsx(here("Data", gl_file_name), 
                             skip = 13,
                             col_types = c(rep("text",2),   
                                           "date", 
                                           rep("text",6),
                                           rep("numeric", 3),
                                           rep("text",26)))


# The first row of the data file is mostly empty except for a few important dates. 
# Read those data and do some formatting to clean up the data.
first_row_of_data <- readxl::read_xlsx(here("Data", budg_vs_act_file_name)) |> 
  names() 

# Should this be first row? As the column_names is not defined?
name_prefixes <- tibble(first_row_of_data) |> 
  mutate(prefixes = ifelse(str_detect(first_row_of_data, "\\.\\."), 
                          NA_character_, 
                          first_row_of_data)) |> 
fill(prefixes, .direction = "down") |> 
  pull(prefixes)

# read the data file again but skip the first line
budg_vs_actuals <- readxl::read_xlsx(here("Data", budg_vs_act_file_name),
                  skip = 1)

#dropping the total budget row as this is not needed and will mess up the data
budg_vs_actuals <- budg_vs_actuals |> 
  filter(`Cost Center` != "Total")

# the names in the file repeat themselves, but this combines the dates with the repetative names
for(i in seq_along(name_prefixes)){
  plain_name <- gsub("\\.\\..*","", names(budg_vs_actuals)[i]) 
  
  names(budg_vs_actuals)[i] <- 
    ifelse(is.na(name_prefixes[i]) & str_length(plain_name) > 0,
           plain_name,
           paste(plain_name,name_prefixes[i], sep = "_"))
}

 names(budg_vs_actuals)
```

## Cleaning the datasets
I need to remove some of the rows that are not needed for the analysis. I will then make the new row be the header row. 

```{r cleaningdata}
# add round all expenditure days to the expenditure month
gl_data <- gl_data |> 
  mutate(expend_month = as.Date(floor_date(`Accounting Date` , unit = "month")))

# remove columns that have nulls for all values, replace "blank" with an actual 'null' value
budg_vs_actuals <- budg_vs_actuals |> 
  select_if(~sum(!is.na(.)) > 0) |> 
  mutate(Grant = ifelse(Grant == "(Blank)", NA_character_, Grant))

#create a dataframe of overall expenditures by worktags from the budget vs actuals file
budg_vs_actuals_overall <- 
  budg_vs_actuals |> 
  select(-matches("_")) 

# create a dataframe of monthly expenditures by worktags from the  budget vs actuals file. Change the table from wide to long.
budget_vs_Actuals_monthly <- 
  budg_vs_actuals |> 
  select(-matches("Budget|total",ignore.case = T)) |> 
  pivot_longer(cols = -!matches("_"), names_to = "date_topic", values_to = "amounts") |> 
  separate(date_topic, sep = "_", into = c("acct_category", "month")) |> mutate(month = as.Date(paste0(month,"-01")))
```

## Monthly amounts match
Check to see if the monthly expenditures for each categories match between the two files.

```{r monthlyamnts}
# aggregate the ledger data by month and worktags
monthly_spendies <- gl_data |> 
  group_by(expend_month, Fund, `Cost Center`, Grant, 
           `Spend Category as Worktag`) |> 
  reframe(total_spend_on_gl = sum(Amount, na.rm = T))

# compare between two files
monthly_spendies_compared <- budget_vs_Actuals_monthly |> 
  filter(acct_category == "Actuals") |> 
  full_join(monthly_spendies, by = c("Cost Center"="Cost Center",
                                     "Fund"="Fund",
                                     "Grant" = "Grant",
                                     "Spend Category" = "Spend Category as Worktag",
                                     "month"="expend_month")) 

# filter on those where values dont match
mismatched_monthly_expenditures <- monthly_spendies_compared |> 
  filter(round(amounts) != round(total_spend_on_gl) ) 

# creating a message to show the number of mismatched rows
message(scales::percent(nrow(mismatched_monthly_expenditures)/nrow(monthly_spendies_compared), accuracy = .1), " of rows are mismatched")

# message states that .6% of rows are mismatched
```

## Overall expenditures
Check to see if the total expenditures for each category match between the two files.

```{r match}
# creating new dataset from the gl_data
overall_spendies <- gl_data |> 
  group_by(Fund, `Cost Center`, Grant, `Spend Category as Worktag`) |> 
  reframe(total_spend_on_gl = sum(Amount, na.rm = T),
          number_of_lines = n())

# joining the budg vs. actual overall data to the overall spendies
overall_spendies_compared <- budg_vs_actuals_overall |> 
    full_join(overall_spendies, by = c("Cost Center"="Cost Center",
                                     "Fund"="Fund",
                                     "Grant" = "Grant",
                                     "Spend Category" = "Spend Category as Worktag")) 

# rounding the total spent and filtering the data to match the variables of the total column
mismatched_overall_expenditures <- overall_spendies_compared |> 
  filter(round(`Total Spent` ) != round(total_spend_on_gl) ) |> 
  mutate_at(vars(matches("total", ignore.case = T)), scales::dollar)

# creating a message to show the number of rows that are mismatched
message(scales::percent(nrow(mismatched_overall_expenditures)/nrow(overall_spendies), accuracy = .1), " are mismatched")

# large amount of mismatches with the data being different for the overall expenditures. 
# 7.8% are different.
```

## Making an output table
This will create the table that can be used for `754 SFSP Expense Report`. Ideally we want to keep the pre-existing data but make placeholders for data that we do not currently have for specific months. What we can do is make placeholders for the data and then we can 

```{r outputtable}
# for now I am using the tot_actual cat - I cannot figure out where they are getting this total bud from

# define all months expected in the report (Jan - Dec)
expected_months <- month.name

# create the expense report table, including the main columns and data
expense_report_tbl <- budg_vs_actuals |> 
  reframe(
    'Service Name' = Service,
    Fund = Fund,
    'Cost Center Name' = `Cost Center`,
    'Spend Category' = `Spend Category`,
    'Total Budget' = `Total Actuals`,
    `Actuals_2024-07` = ifelse(is.na(`Actuals_2024-07`), "", `Actuals_2024-07`),
    `Actuals_2024-08` = ifelse(is.na(`Actuals_2024-08`), "", `Actuals_2024-08`),
    `Actuals_2024-09` = ifelse(is.na(`Actuals_2024-09`), "", `Actuals_2024-09`),
    `Actuals_2024-10` = ifelse(is.na(`Actuals_2024-10`), "", `Actuals_2024-10`),
    `Actuals_2024-11` = ifelse(is.na(`Actuals_2024-11`), "", `Actuals_2024-11`),
    `Actuals_2024-12` = ifelse(is.na(`Actuals_2024-12`), "", `Actuals_2024-12`),
    # Add placeholders for missing months
    `Actuals_2024-01` = "",
    `Actuals_2024-02` = "",
    `Actuals_2024-03` = "",
    `Actuals_2024-04` = "",
    `Actuals_2024-05` = "",
    `Actuals_2024-06` = ""
  )

# find which months already exist in the data (based on column names)
existing_months <- colnames(expense_report_tbl) |> 
  str_extract("(?<=Actuals_2024-)[0-9]{2}") |> 
  as.numeric() |> 
  na.omit() 

# naming the columns by their respective month names. So this will take away the crazy names of the actuals.
existing_month_names <- month.name[existing_months]

# identify the missing months (those that aren't in the existing data)
missing_months <- setdiff(expected_months, existing_month_names)

# preserve existing data, but for missing months, make them blank
expense_report_tbl <- expense_report_tbl |> 
  reframe(
    across(
      .cols = all_of(existing_month_names),
      .fns = ~ ifelse(is.na(.), "", .),
      .names = "{.col}"  # Keep original month name
    )
  )



# find which months already exist in the data (based on column names)
existing_months <- colnames(expense_report_tbl) |> 
  str_extract("(?<=Actuals_2024-)([0-9]{2})") |>  # Use a non-capturing group for two digits
  na.omit() |> 
  as.numeric()  # Convert to numeric for comparison

existing_month_names <- month.name[existing_months]
# Identify missing months (those that aren't in the existing data)
missing_months <- setdiff(expected_months, existing_month_names)

# Create columns for existing months with blank strings for missing data
df <- df |> 
  mutate(
    across(
      .cols = all_of(existing_month_names),
      .fns = ~ ifelse(is.na(.), "", .),
      .names = "{.col}"  # Use original month name
    )
  )

# Add the missing months as blank columns (empty strings)
for (month in missing_months) {
  df[[month]] <- ""  # Add blank columns for missing months
}

print(df)
```

### Plots
Making some plots that show different perspectives on the budgets vs. actuals.

## Negative Spending
The plot below will show negative spending for service types vs. total spent.

```{r totspentnegplot}
# remove the leading numbers before the service name for plotting 
budg_vs_actuals <- budg_vs_actuals |> 
  mutate(Service = sub("^\\S+\\s*", "", Service))

# filter the dataset for negative spending values
negative_spending <- budg_vs_actuals|> 
  filter(`Total Spent` < 0)

# plotting data below for different perspectives
tot_neg_spending <- ggplot(negative_spending, aes(x = Service, y = `Total Spent`)) +
  geom_col(fill = "red") +  # Bar plot with red bars for negative values
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +
  labs(title = "Services with Negative Spending", 
       x = "Service", 
       y = "Total Spent") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 20),  # Adjust x-axis text size
    axis.text.y = element_text(size = 20),  # Adjust y-axis text size
    axis.title.x = element_text(size = 22),  # Adjust x-axis title size
    axis.title.y = element_text(size = 20),  # Adjust y-axis title size
    plot.title = element_text(size = 25, hjust = 0.5)  # Adjust plot title size
  )

# viewing the plot
tot_neg_spending

# saving the plot
ggsave("tot_neg_spending.pdf",
       width = 30, height = 20)
```

## July Actual Spending
The plot below will show spending for service types and July actual spent.

```{r julyplot}
# Create a plot showing Actuals spent for July by Service with positive (blue) and negative (red) bars
july_spending_plot <- ggplot(budg_vs_actuals, aes(x = Service, y = `Actuals_2024-07`, fill = `Actuals_2024-07` > 0)) +
  geom_col() +  # Create bars
  scale_fill_manual(values = c("red", "blue"), 
                    labels = c("Negative", "Positive")) +  # Custom legend labels
  theme_minimal() +
  scale_y_continuous(labels = scales::comma) +  # Format y-axis to show real values
  labs(title = "Actual Spending for July by Service", 
       x = "Service", 
       y = "Actuals Spent (July 2024)") +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 20),  # X-axis text size
    axis.text.y = element_text(size = 22),  # Y-axis text size
    axis.title.x = element_text(size = 20),  # X-axis title size
    axis.title.y = element_text(size = 20),  # Y-axis title size
    plot.title = element_text(size = 24, hjust = 0.5),  # Plot title size
    legend.title = element_blank(),  # Remove legend title
    legend.text = element_text(size = 24),  # Increase legend text size
    legend.key.size = unit(1.5, "lines")  # Increase the size of the legend key (color box)
  )

# Print the plot
print(july_spending_plot)

# saving the plot
ggsave("july_spending_plot.pdf",
       width = 30, height = 20)
```






## Example code below

# the code below will read a Payroll Expense Ledger report
# from workday and create a summary excel file and a couple charts

# these will load a couple additional R tools for the work
# libraries are extra R tools

```{r libraries}
library(tidyverse)
library(ggplot2)
```

## Reading the expenditure data
This will read the excel file. The file needs to be in the same folder as the R script. And the name in parenthesis needs to match the file name of the excel file.

```{r expendata}
expenditure_data <-
  readxl::read_xlsx("June Payroll Expense Ledger by Org Excel 2024-07-17 10_21 EDT.xlsx",
                    skip = 8)
```

## Aggregating and summing the expenditures
This part aggregates the transaction in the GL file by service then sums the expenditures.

```{r groupby}
service_exp <- expenditure_data |>
  group_by(`Service (Cost Center Hierarchy)`) |>
  summarise(total_expenditures = sum(`Ledger Amount ($)`)) |>
  ungroup() |>
  arrange(desc(total_expenditures))
```

## Creating an object
You just created an object called "service_exp" which can be seen be executing this.

```{r print}
print(service_exp)
```

## Aggregating the GL file by cost center
This part aggregates the transaction in the GL file by cost center then sums the expenditures.

```{r aggregates}
cost_center_exp <- expenditure_data |>
  group_by(`Cost Center`) |>
  summarise(total_expenditures = sum(`Ledger Amount ($)`)) |>
  ungroup() |>
  arrange(desc(total_expenditures))
```

## Creating an object 
you just created an object called "cost_center_exp" which can be seen be executing this.

```{r object}
cost_center_exp
```

## Writing out the costcenter and the expenitures to an excel file 
This part creates an excel file with the cost center and service expenditures.

```{r write_excel_file}
writexl::write_xlsx(list(`expend by service` = service_exp,
                         `expend by cost center` = cost_center_exp), "summarized_expenditures.xlsx")
```


## Aggregating the data
This part aggregates by date posted, summing expenditures by the day the posted to the GL.

```{r sums}
daily_spend <- expenditure_data |>
  mutate(day = floor_date(as.Date(`Accounting Date` ), "day")) |>
  group_by(day) |>
  summarise(total_expenditures = sum(`Ledger Amount ($)`)) |>
  ungroup()

print(daily_spend)
```

## Making the Chart
This part makes the chart using columns from the daily_spend dataframe.

```{r charts}
daily_spend |>
  ggplot(aes(day, total_expenditures))+
  geom_col() +
  theme_classic() +
  scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6)) +
  geom_hline(yintercept=0) +
  labs(title = "DGS Posted Expenditures throughout the month of June 2024",
       subtitle = "Expenditures by day",
       y = "Expenditures ($)",
       x = "Date posted on GL")
```

## Saving the chart 
This part saves the chart.

```{r savingchart}
ggsave("daily_spend.pdf",
       width = 8, height = 5)
```


## Aggregates 
This part aggregates bby fund, summing expenditures, then makes a chart.

```{r exped_plot}
expenditure_data |>
  separate(Fund, into = c("number", "Fund"), extra = "merge", remove = T) |>
  group_by(Fund) |>
  summarise(total_spend = sum(`Ledger Amount ($)`)) |>
  ggplot(aes(reorder(Fund, (total_spend)), total_spend)) +
  geom_col(fill = "orange") +
  theme_classic() +
  coord_flip() +
  scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6), expand = c(0, 0), limits = c(0,3000000))+
  labs(title = "DGS Posted Expenditures by Fund",
       subtitle = "Posted in June 2024",
       y = "Expenditures ($)",
       x = "")
```

## Saving the chart as PDF
This saves the chart as a pdf.

```{r savingplot}
ggsave("spend_by_fund.pdf",
       width = 8.5, height = 5)
```

## Filtering  
This part filters transaction to the manual JEs then aggregates by by fund summing the GL transactions by the fund.

```{r filters}
manual_change_data <- expenditure_data |>
  filter(str_detect(`Journal Source`, "Manual")) |>
  separate(Fund, into = c("number", "Fund"), extra = "merge", remove = T) |>
  group_by(Fund) |>
  summarise(total_spend = sum(`Ledger Amount ($)`))
```

## Chart for manual GL's 
This part makes the chart showing where the manual GL's occur.

```{r ggplot}
ggplot() +
  geom_col(data = manual_change_data,
           mapping = aes(reorder(`Fund`, (total_spend)), total_spend),
           fill = "orange") +
  geom_text(data = manual_change_data,
            mapping = aes(reorder(`Fund`, (total_spend)), 0,
                          label = scales::dollar(total_spend/1000000, suffix = "M")), hjust = -.2) +
  theme_classic() +
  geom_hline(yintercept=0) +
  coord_flip() +
  geom_text() +
  scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6), expand = c(0, 0))+
  labs(title = "Manual Accounting Adjustments",
       subtitle = "Made in June 2024",
       y = "Expenditures ($)",
       x = "")

```

## Saving the chart to PDF format
This saves the chart as a pdf.

```{r ggsave}
ggsave("manual_adjustments_by_fund.pdf",
       width = 8.5, height = 5)
```


















