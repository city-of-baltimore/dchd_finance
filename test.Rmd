---
title: "Gl_and_Budget_vs_Actuals"
author: "Selenea Gibson & Jason Howard"
date: "2025-01-02"
output: html_document
---

# Project Overview
This markdown file will use the DHCD Finance dept documents that are for reporting expenditures and GL data. The data is collected from Workday.

```{r libraries, warning=FALSE, message=TRUE}
# libraries for data analysis
library(dplyr)
library(here)
library(tidyverse)
library(scales)
library(DT)
library(openxlsx)
library(stringr)
library(lubridate)
```

## Reading in the data 
Reading in the files for the data that will be used. Put new data files in the "Data" folder and replace the file names below with the names of the new files.

```{r data}
# change the names of these files to represent the newest file downloaded
gl_file_name <- "GL-Operating Actual Expenses YTD 2024-12-19 13_03 EST.xlsx"

budg_vs_act_file_name <- "Budget_vs_Actuals_-_BBMR YTD 2024-12-19.xlsx" 
 
# read data from files
gl_data <- readxl::read_xlsx(here("Data", gl_file_name), 
                             skip = 13,
                             col_types = c(rep("text",2),   
                                           "date", 
                                           rep("text",6),
                                           rep("numeric", 3),
                                           rep("text",26)))


# the first row of the data file is mostly empty except for a few important dates. 
# read those data and do some formatting to clean up the data
first_row_of_data <- readxl::read_xlsx(here("Data", budg_vs_act_file_name)) |> 
  names() 

# take out the data that is before the numeric values
name_prefixes <- tibble(first_row_of_data) |> 
  mutate(prefixes = ifelse(str_detect(first_row_of_data, "\\.\\."), 
                          NA_character_, 
                          first_row_of_data)) |> 
fill(prefixes, .direction = "down") |> 
  pull(prefixes)

# read the data file again but skip the first line
budg_vs_actuals <- readxl::read_xlsx(here("Data", budg_vs_act_file_name),
                  skip = 1)

#dropping the total budget row as this is not needed and will mess up the data
budg_vs_actuals <- budg_vs_actuals |> 
  filter(`Cost Center` != "Total")

# the names in the file repeat themselves, but this combines the dates with the repetitive names
for(i in seq_along(name_prefixes)){
  plain_name <- gsub("\\.\\..*","", names(budg_vs_actuals)[i]) 
  
  names(budg_vs_actuals)[i] <- 
    ifelse(is.na(name_prefixes[i]) & str_length(plain_name) > 0,
           plain_name,
           paste(plain_name,name_prefixes[i], sep = "_"))
}

 names(budg_vs_actuals)
```

## Cleaning the datasets
I need to remove some of the rows that are not needed for the analysis. I will then make the new row be the header row. 

```{r cleaningdata}
# add round all expenditure days to the expenditure month
gl_data <- gl_data |> 
  mutate(expend_month = as.Date(floor_date(`Accounting Date` , unit = "month")))

# remove columns that have nulls for all values, replace "blank" with an actual 'null' value
budg_vs_actuals <- budg_vs_actuals |> 
  select_if(~sum(!is.na(.)) > 0) |> 
  mutate(Grant = ifelse(Grant == "(Blank)", NA_character_, Grant))

# create a dataframe of overall expenditures by worktags from the budget vs actuals file
budg_vs_actuals_overall <- budg_vs_actuals |> 
  select(-matches("_")) 

# create a dataframe of monthly expenditures by worktags from the  budget vs actuals file. Change the table from wide to long.
budget_vs_Actuals_monthly <- budg_vs_actuals |> 
  select(-matches("Budget|total",ignore.case = T)) |> 
  pivot_longer(cols = -!matches("_"), names_to = "date_topic", values_to = "amounts") |> 
  separate(date_topic, sep = "_", into = c("acct_category", "month")) |> mutate(month = as.Date(paste0(month,"-01")))
```

## Monthly amounts match
Check to see if the monthly expenditures for each categories match between the two files.

```{r monthlyamnts}
# aggregate the ledger data by month and worktags
monthly_spendies <- gl_data |> 
  group_by(expend_month, Fund, `Cost Center`, Grant, 
           `Spend Category as Worktag`) |> 
  reframe(total_spend_on_gl = sum(Amount, na.rm = T))

# compare between two files
monthly_spendies_compared <- budget_vs_Actuals_monthly |> 
  filter(acct_category == "Actuals") |> 
  full_join(monthly_spendies, by = c("Cost Center"="Cost Center",
                                     "Fund"="Fund",
                                     "Grant" = "Grant",
                                     "Spend Category" = "Spend Category as Worktag",
                                     "month"="expend_month")) 

# filter on those where values dont match
mismatched_monthly_expenditures <- monthly_spendies_compared |> 
  filter(round(amounts) != round(total_spend_on_gl) ) 

# creating a message to show the number of mismatched rows
message(scales::percent(nrow(mismatched_monthly_expenditures)/nrow(monthly_spendies_compared), accuracy = .1), " of rows are mismatched")

# message states that .6% of rows are mismatched
```

## Overall expenditures match
Check to see if the total expenditures for each category match between the two files.

```{r ovrexps}
# creating new dataset from the gl_data
overall_spendies <- gl_data |> 
  group_by(Fund, `Cost Center`, Grant, `Spend Category as Worktag`) |> 
  reframe(total_spend_on_gl = sum(Amount, na.rm = T),
          number_of_lines = n())

# joining the budg vs. actual overall data to the overall spendies
overall_spendies_compared <- budg_vs_actuals_overall |> 
    full_join(overall_spendies, by = c("Cost Center"="Cost Center",
                                     "Fund"="Fund",
                                     "Grant" = "Grant",
                                     "Spend Category" = "Spend Category as Worktag")) 

# rounding the total spent and filtering the data to match the variables of the total column
mismatched_overall_expenditures <- overall_spendies_compared |> 
  filter(round(`Total Spent` ) != round(total_spend_on_gl) ) |> 
  mutate_at(vars(matches("total", ignore.case = T)), scales::dollar)

# creating a message to show the number of rows that are mismatched
message(scales::percent(nrow(mismatched_overall_expenditures)/nrow(overall_spendies), accuracy = .1), " are mismatched")

# large amount of mismatches with the data being different for the overall expenditures. 
# 7.8% are different.
```

## Making an output table
This will create the table that can be used for `754 SFSP Expense Report`. 

```{r outputtable, warning=FALSE}
# Extract unique years dynamically from actuals columns
years <- unique(na.omit(str_extract(names(budg_vs_actuals), "(?<=Actuals_)\\d{4}")))

# Define all possible Year-Month combinations based on detected years
months <- sprintf("%02d", 1:12)
all_year_months <- unlist(lapply(years, function(year) paste(year, months, sep = "-")))

# Build the expense report table dynamically
expense_report_tbl <- budg_vs_actuals |> 
  reframe(
    'Service Name' = Service,
    Fund = Fund,
    'Cost Center' = `Cost Center`,
    'Spend Category' = `Spend Category`,
    'Revised Budget' = `Revised Budget`
  ) |> 
  # Add placeholder columns dynamically for all Year-Month combinations
  bind_cols(
    as_tibble(setNames(
      lapply(all_year_months, function(x) {
        column_name <- paste0("Actuals_", x)
        if (column_name %in% names(budg_vs_actuals)) {
          budg_vs_actuals[[column_name]]
        } else {
          rep(NA, nrow(budg_vs_actuals))
        }
      }), paste0("Actuals_", all_year_months)
    ))
  )

# Rename columns for readability with correct month names
expense_report_tbl <- expense_report_tbl |> 
  rename_with(
    .fn = function(x) {
      month_num <- as.integer(str_extract(x, "(?<=-)(\\d{2})"))
      year_num <- str_extract(x, "(?<=Actuals_)(\\d{4})")
      
      ifelse(
        grepl("^Actuals_", x) & !is.na(month_num) & !is.na(year_num),
        paste0(str_to_title(month.name[month_num]), " ", year_num),
        x  # Keep original name if it doesn't match the pattern
      )
    }
  )

# Convert actuals columns to numeric safely
expense_report_tbl <- expense_report_tbl |> 
  mutate(across(starts_with("Actuals_"), as.numeric, .names = "clean_{.col}"))
```

## Calculating the Total Expenditures and the GL_YTD_EXP columns 
Here I am calculating the Total Expenditures and the GL_YTD_EXP columns. This will be automatic depending on the data that is in the dataset so you do not need to change this everytime a new month with data is added.

**This will need to be double checked**

```{r newcolumns}
# --- calculation for the Total Expenditures ---
# Identify all month columns dynamically (only those with month-year format)
month_cols <- names(expense_report_tbl)[str_detect(names(expense_report_tbl), "^[A-Za-z]+ \\d{4}$")]

# sum across detected month columns
expense_report_tbl <- expense_report_tbl |> 
  mutate(`Total Expenditures` = rowSums(across(all_of(month_cols)), na.rm = TRUE))

# --- aggregate the GL_YTD_EXP by Fund, Spend Category, and Cost Center ---
gl_data_exp <- gl_data |> 
  group_by(Fund, `Spend Category as Worktag`, `Cost Center`) |> 
  summarise(`GL YTD EXP` = sum(Amount, na.rm = TRUE), .groups = "drop")


# joining the data to the expense_report_tbl
expense_report_tbl <- expense_report_tbl |> 
  left_join(gl_data_exp, 
            by = c("Spend Category" = "Spend Category as Worktag", 
                   "Cost Center" = "Cost Center", 
                   "Fund" = "Fund"))
```

###
### Create the Excel workbook
Now I will create the workbook that will be used to display the data that is seen on the `754 SFSP Expense Report`. 

I am going to break it up in steps to make it easier to follow. 

1. I want to put all of the service data into a dataset that will have everything in it.
2. I want to filter the data to only be focused on the Summer Food Service Program.
3. I want to sort by the Fund column to show the general fund first then the state fund. 

```{r filteringsumprogram}
# --- define the fiscal year months order starting with July ---
fiscal_year_months <- c("July", "August", "September", "October", "November", "December", 
                        "January", "February", "March", "April", "May", "June")

# --- reorder the month columns based on fiscal year order ---
month_cols_sorted <- month_cols[order(match(sub("^(\\w+).*", "\\1", month_cols), fiscal_year_months))]

# --- create the all_expense_rep dataframe dynamically ---
all_expense_rep <- expense_report_tbl |> 
  arrange(`Service Name`, `Spend Category`) |> 
  select(
    `Service Name`, 
    Fund, 
    `Cost Center`, 
    `Spend Category`, 
    `Revised Budget`,
    all_of(month_cols_sorted),  # Dynamically select all month-year columns
    `Total Expenditures`,
    `GL YTD EXP`
  )

# filter to show the summer_food_program only have to put the full name into the filter
summer_expense_rep <- all_expense_rep |> 
  filter(`Service Name` == "SRV0754 Summer Food Service Program")

# sort data and arrange by the Fund name to show the 1001 General Fund first
summer_expense_rep <- summer_expense_rep |> 
  arrange(Fund, `Service Name`, `Spend Category`)
```

4. Creating the workbook.
There is a lot going on here. So what this section is doing is creating the workbook but in sections. 

```{r workbook}
# --- identifying the first row for the data ---

# find the first row of "1001 General Fund", "5000 State Grants Fund", and the "CCA000347 Summer Food Service Program"
first_row_sfp <- which(tolower(summer_expense_rep$`Service Name`) == tolower("SRV0754 Summer Food Service Program")) |> 
  min()
first_row_1001gf <- which(tolower(summer_expense_rep$Fund) == "1001 general fund") |>
  min()
first_row_5000sf <- which(tolower(summer_expense_rep$Fund) == "5000 state grants fund") |>
  min()
first_row_ccn <- which(tolower(summer_expense_rep$`Cost Center`) == tolower("CCA000347 Summer Food Service Program")) |> 
  min()

# --- create a workbook ---

# add the worksheet to the created workbook
wb1 <- createWorkbook()
addWorksheet(wb1, "Summer Expense Report")

# --- add Title (Row 1) ---

# add a header, style, and color with the label "Summer Analysis" in the first row
writeData(wb1, "Summer Expense Report", "FY 2024 Budget and Actual as of 07/31/2024", startRow = 1, startCol = 1)
header_style <- createStyle(halign = "center", valign = "center", textDecoration = "bold", fgFill = "#ED7D31")

# merge the cells
mergeCells(wb1, "Summer Expense Report", cols = 1:ncol(summer_expense_rep), rows = 1)
addStyle(wb1, "Summer Expense Report", header_style, rows = 1, cols = 1:ncol(summer_expense_rep), gridExpand = TRUE)

# --- align for column headers ---

# center alignment for column headers
center_style <- createStyle(halign = "center", valign = "center")
addStyle(wb1, "Summer Expense Report", center_style, rows = 2, cols = 1:ncol(summer_expense_rep), gridExpand = TRUE)

# --- style the column names (e.g., "Service Name", "Fund", etc.) ---

# styling the column names for the datatable
column_names_style <- createStyle(
  halign = "center", 
  valign = "center", 
  textDecoration = "bold", 
  fgFill = "#ED7D31" 
)

# apply the style to the column names (first row of data)
addStyle(wb1, "Summer Expense Report", column_names_style, rows = 2, cols = 1:ncol(summer_expense_rep), gridExpand = TRUE)

# --- identify after first appearance ---

# reset "Service Name", "Fund", and "Cost Center Name" after first appearance
summer_expense_rep$`Service Name` <- ""
summer_expense_rep$Fund <- ""
summer_expense_rep$`Cost Center` <- ""

# --- assign first appearance ---

# ensure first appearance of each section is retained
summer_expense_rep$`Service Name`[first_row_sfp] <- "SRV0754 Summer Food Service Program"

summer_expense_rep$Fund[first_row_1001gf] <- "1001 General Fund"

summer_expense_rep$Fund[first_row_5000sf] <- "5000 State Grants Fund"

summer_expense_rep$`Cost Center`[first_row_ccn] <- "CCA000347 Summer Food Service Program"

# --- add blank rows ---

# add blank rows after each section
writeData(wb1, "Summer Expense Report", matrix("", nrow = 1, ncol = ncol(summer_expense_rep)), 
          startRow = first_row_1001gf + 1, colNames = FALSE)

writeData(wb1, "Summer Expense Report", matrix("", nrow = 1, ncol = ncol(summer_expense_rep)), 
          startRow = first_row_5000sf + 2, colNames = FALSE)

writeData(wb1, "Summer Expense Report", matrix("", nrow = 1, ncol = ncol(summer_expense_rep)), 
          startRow = first_row_ccn + 2, colNames = FALSE)

# --- write Data and Format Sections ---

# write data before each blank row
writeData(wb1, "Summer Expense Report", summer_expense_rep[1:first_row_1001gf, ], colNames = TRUE, startRow = 2)

writeData(wb1, "Summer Expense Report", summer_expense_rep[(first_row_1001gf + 1):first_row_5000sf, ], 
          startRow = first_row_1001gf + 3, colNames = FALSE)

writeData(wb1, "Summer Expense Report", summer_expense_rep[(first_row_5000sf + 1):first_row_ccn, ], 
          startRow = first_row_5000sf + 3, colNames = FALSE)

writeData(wb1, "Summer Expense Report", 
          summer_expense_rep[(first_row_5000sf + 1):first_row_ccn, ], 
          startRow = first_row_5000sf + 2, colNames = FALSE)

# re-assign first_row_ccn value to appear after first_row_5000sf
summer_expense_rep$`Cost Center`[first_row_5000sf] <- "CCA000347 Summer Food Service Program"


# --- write the rest of the data ---

# write remaining data after the last section
writeData(wb1, "Summer Expense Report", summer_expense_rep[(first_row_ccn + 1):nrow(summer_expense_rep), ], 
          startRow = first_row_ccn + 3, colNames = FALSE)

# # --- saving the workbook ---
# 
# save the workbook
saveWorkbook(wb1, "summer_food_program_report.xlsx", overwrite = TRUE)
```

5. Calculating the columns for the Analysis Table
Create the columns that are needed for the second table that is in the `754 SFSP Expense Report`.

```{r calculatingcols, warning=FALSE}
# create a new dataframe with only the new columns included and not the rest
# tblwhodis is a placeholder for the new calculated columns

# --- calculate the Remaining Balance column ---
# create a new column for the remaining balance and make the gl ytd exp numeric
tblwhodis <- summer_expense_rep |> 
  mutate(
    `Revised Budget` = as.numeric(gsub("[^0-9.]", "", `Revised Budget`)),
    `GL YTD EXP` = as.numeric(gsub("[^0-9.]", "", `GL YTD EXP`)),
    `Remaining Balance` = ifelse(
      is.na(`Revised Budget`) | is.na(`GL YTD EXP`), 
      NA,  # If either value is NA, set Remaining Balance to NA
      `Revised Budget` - `GL YTD EXP`  # Subtraction if both are valid
    )
  )
# --- create a numerical fiscal month ---

# Assign each month a number (July = 1, August = 2, ..., June = 12)
month_to_fiscal <- c(
  "July" = 1, "August" = 2, "September" = 3, "October" = 4, "November" = 5, "December" = 6,
  "January" = 7, "February" = 8, "March" = 9, "April" = 10, "May" = 11, "June" = 12
)

# Detect the maximum fiscal month dynamically by checking the existing months in the dataframe
existing_months <- names(expense_report_tbl)[str_detect(names(expense_report_tbl), "^[A-Za-z]+ \\d{4}$")]
month_names_in_data <- sub(" \\d{4}$", "", existing_months)  # Extract month names

# Get the latest fiscal month from the data
detected_month <- names(month_to_fiscal)[
  max(which(month_names_in_data %in% names(month_to_fiscal))) 
]

# --- Projected Y|E Value calculation ---
tblwhodis <- tblwhodis |> 
  mutate(
    # Get the FiscalMonth based on the latest detected month
    FiscalMonth = month_to_fiscal[detected_month],  
    # Calculate Projected Y|E Value if both GL YTD EXP and FiscalMonth are valid
    `Projected Y|E Value` = ifelse(
      is.na(`GL YTD EXP`) | is.na(FiscalMonth), 
      NA,  # Return NA if either GL YTD EXP or FiscalMonth is missing
      (`GL YTD EXP` / FiscalMonth) * 12  # Project the year-end value
    )
  ) |> 
  select(everything())  # Retain all original columns, including `Remaining Balance`

# --- Sur / (Def) column ---

# calculate the new column here
tblwhodis <- tblwhodis |>
  mutate(
    `Sur / (Def)` = ifelse(
      is.na(`Revised Budget`) | is.na(`Projected Y|E Value`),
      NA,  # Return NA if either column is missing
      `Revised Budget` - `Projected Y|E Value`  # Subtraction calculation
    )
  )

# --- Notes column ---# ---`Projected Y|E Value` Notes column ---

# here we will make a notes column that can be used in excel
# initialize as empty character column
tblwhodis$Notes <- NA_character_  
```

6. Creating the Analysis Table
This is the analysis table that will be apart of the main excel table.

```{r analysistbk}
# only keep the columns that are needed for this table
analysis_tbl <- tblwhodis |> 
  select(`Remaining Balance`, `Projected Y|E Value`, `Sur / (Def)`, Notes)

# --- create a workbook ---

# add the worksheet to the created workbook
wb2 <- createWorkbook()
addWorksheet(wb2, "analysis_tbl")

# --- write data to the worksheet 2 ---

writeData(wb2, "analysis_tbl", analysis_tbl, startRow = 2, startCol = 1, colNames = TRUE)

# --- header for the table---

# add a header, style, and color with the label "Analysis" in the first row
writeData(wb2, "analysis_tbl", "ANALYSIS", startRow = 1, startCol = 1)
header_style <- createStyle(halign = "center", valign = "center", textDecoration = "bold", fgFill = "#C6E0B4")

# merge the cells
mergeCells(wb2, "analysis_tbl", cols = 1:ncol(analysis_tbl), rows = 1)
addStyle(wb2, "analysis_tbl", header_style, rows = 1, cols = 1:ncol(analysis_tbl), gridExpand = TRUE)

# --- align for column headers ---

# center alignment for column headers
center_style <- createStyle(halign = "center", valign = "center")
addStyle(wb2, "analysis_tbl", center_style, rows = 2, cols = 1:ncol(analysis_tbl), gridExpand = TRUE)

# --- style the column names (e.g., "Remaining Balance", "Sur / (Def)", etc.) ---

# styling the column names for the datatable
column_names_style <- createStyle(
  halign = "center", 
  valign = "center", 
  textDecoration = "bold", 
  fgFill = "#C6E0B4" 
)

# apply the style to the column names (first row of data)
addStyle(wb2, "analysis_tbl", column_names_style, rows = 2, cols = 1:ncol(analysis_tbl), gridExpand = TRUE)

# --- save the workbook 2 ---

# saving the workbook
saveWorkbook(wb2, "analysis_tbl.xlsx", overwrite = TRUE)
```

7. Combining the workbooks
Last step, "Whew!", is to join the two of these workbooks together to have 1 full working workbook that can be used for the team. 

```{r combiningwbs}
# --- combine the two workbooks on the same worksheet with full formatting ---

# create a new workbook for the combined data
wb_combined <- createWorkbook()

# add a worksheet for combined data
addWorksheet(wb_combined, "tables_unite")

# define styles
title_style_summer <- createStyle(halign = "center", valign = "center", textDecoration = "bold", fgFill = "#FFA500", fontSize = 11)
title_style_analysis <- createStyle(halign = "center", valign = "center", textDecoration = "bold", fgFill = "#C6E0B4", fontSize = 11)

header_style_summer <- createStyle(halign = "center", valign = "center", textDecoration = "bold", fgFill = "#FFA500")
header_style_analysis <- createStyle(halign = "center", valign = "center", textDecoration = "bold", fgFill = "#C6E0B4")

# --- write the first table (summer_expense_rep) with title and formatting ---

# add title for the first table
writeData(wb_combined, "tables_unite", "Summer Expense Report", startRow = 1, startCol = 1)
mergeCells(wb_combined, "tables_unite", cols = 1:ncol(summer_expense_rep), rows = 1)
addStyle(wb_combined, "tables_unite", title_style_summer, rows = 1, cols = 1:ncol(summer_expense_rep), gridExpand = TRUE)

# write the first table
writeData(wb_combined, "tables_unite", summer_expense_rep, startRow = 2, startCol = 1, colNames = TRUE)

# apply column header style to the first table
addStyle(wb_combined, "tables_unite", header_style_summer, rows = 2, cols = 1:ncol(summer_expense_rep), gridExpand = TRUE)

# --- add 2 blank columns for separation ---

# count the number of rows and columns
num_rows_summer <- nrow(summer_expense_rep)
num_cols_summer <- ncol(summer_expense_rep)

# write blank columns for separation
writeData(wb_combined, "tables_unite", matrix("", nrow = num_rows_summer + 2, ncol = 2), 
          startRow = 1, startCol = num_cols_summer + 1, colNames = FALSE)

# --- Write the second table (analysis_tbl) with title and formatting ---

# add title for the second table
writeData(wb_combined, "tables_unite", "Analysis Table", startRow = 1, startCol = num_cols_summer + 3)
mergeCells(wb_combined, "tables_unite", cols = (num_cols_summer + 3):(num_cols_summer + 2 + ncol(analysis_tbl)), rows = 1)
addStyle(wb_combined, "tables_unite", title_style_analysis, rows = 1, cols = (num_cols_summer + 3):(num_cols_summer + 2 + ncol(analysis_tbl)), gridExpand = TRUE)

# write the second table
writeData(wb_combined, "tables_unite", analysis_tbl, startRow = 2, startCol = num_cols_summer + 3, colNames = TRUE)

# apply column header style to the second table
addStyle(wb_combined, "tables_unite", header_style_analysis, rows = 2, cols = (num_cols_summer + 3):(num_cols_summer + 2 + ncol(analysis_tbl)), gridExpand = TRUE)

# --- save the combined workbook ---

# saving the workbook
# r does not like slashes so you need to do underscores
# update the name of the output file as needed
saveWorkbook(wb_combined, "FY 2024 Budget and Actual as of 12_31_2024.xlsx", overwrite = TRUE) # change the name of the output file accordingly
```

#### YOU DID IT ####
Congratulations! You did a wonderful job coding! 
If this is your first real coding script, then I must say you choose a tricky script. 
Go ahead and call yourself a Rstudio programmer you data analyst!













